<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuntimeFS</title>
    <style>
        * {
            font-family: monospace;
        }

        body {
            cursor: default;
        }

        hr {
            border: 1px solid white;
        }

        html {
            background-color: black;
            color: white;
        }

        .supportCheck,
        #encryptionSection {
            display: none;
        }

        button {
            border: solid #ceface 1.5px;
            border-radius: 5px;
            padding: 4px;
            cursor: pointer;
            transition: background-color 200ms;
            background-color: #15e264;
        }

        button:disabled {
            cursor: not-allowed;
        }

        h1,
        h2 {
            color: #d7b7f2;
        }

        fieldset {
            border: solid 1px #83ceec;
            border-radius: 15px;
            margin-bottom: 1em;
        }

        input[type=text] {
            width: 175px;
        }

        input[type=checkbox] {
            cursor: pointer;
        }

        button:hover {
            background-color: #14af50;
        }

        button:active {
            background-color: #098438;
        }

        input,
        textarea {
            transition: background-color 400ms, filter 800ms;
            background-color: #3a5774;
            border: solid #959595 1.5px;
            border-radius: 5px;
            color: white;
        }

        input:placeholder-shown,
        textarea:placeholder-shown {
            background-color: #262e36;
        }

        input:focus,
        textarea:focus {
            background-color: #5d5ba3;
            box-shadow: 0 0 8px white;
        }

        input::placeholder,
        textarea::placeholder {
            color: #b8b8b8;
        }
    </style>
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            var errorMessage = message || "An unknown error occurred."
            var stackTrace = "No stack available"

            if (error instanceof Error) {
                stackTrace = error.stack || "No stack available"
                errorMessage = `Error: ${error.message}\r\nSource: ${source}:${lineno}:${colno}`
            } else {
                errorMessage = `Error: ${errorMessage}\r\nSource: ${source}:${lineno}:${colno}`
            }

            alert("A script error occurred: " + errorMessage + "\r\nStack trace:\r\n" + stackTrace);
            try {
                setUiBusy(false)
                logProgress("", true)
                document.getElementById("syncInfo").textContent = ""
            } finally { }
        }
        window.onunhandledrejection = function (e) {
            var reason = e.reason
            if (reason instanceof Error && reason.name === "NotSupportedError") {
                console.warn("Caught and ignored a FileSystemObserver NotSupportedError. This is expected in some browsers.")
                return
            }

            var errorMessage = "An unknown error occurred."
            if (reason instanceof Error) {
                errorMessage = `Error: ${reason.message}\r\nStack trace: ${reason.stack || "No stack available"}`
            } else if (typeof reason === "string") {
                errorMessage = `Error: ${reason}`
            } else if (reason !== null && typeof reason === "object") {
                try {
                    errorMessage = `Object error: ${JSON.stringify(reason)}`
                } catch (e) {
                    errorMessage = "Object error occured (cannot display object contents)"
                }
            } else {
                errorMessage = `Error: ${String(reason)}`
            }

            alert("An unhandled rejection occurred:\r\n" + errorMessage)
            try {
                setUiBusy(false)
                logProgress("", true)
                document.getElementById("syncInfo").textContent = ""
            } finally { }
        }
    </script>
    <script src="main.min.js" defer></script>
</head>

<body>
    <h1>RuntimeFS</h1>

    <fieldset>
        <legend>
            <h2>Manage Folders</h2>
        </legend>
        <label for="folderName">Folder Name:</label>
        <input type="text" id="folderName" placeholder="Enter a name...">
        <button onclick="uploadFolder()">Upload Folder</button>
        <button onclick="syncFiles()" class="supportCheck">Sync</button>
        <span id="syncInfo" class="supportCheck"></span>
        <input type="file" id="folderUploadFallbackInput" webkitdirectory directory style="display: none">
        <hr>
        <label for="openFolderName">Folder to Open:</label>
        <input type="text" id="openFolderName" placeholder="Enter folder name...">
        <label for="fileName" placeholder="File name...">File:</label>
        <input type="text" id="fileName" placeholder="index.html (optional)">
        <button onclick="openFile()">Open</button>
        <button onclick="openFileInPlace()">In-Place Open</button>
        <button onclick="syncAndOpenFile()" class="supportCheck">Sync and Open</button>
    </fieldset>

    <fieldset>
        <legend>
            <h2>Data Management</h2>
        </legend>
        <div style="display: flex; gap: 20px; align-items: flex-start">
            <div>
                <strong>Existing Folders:</strong>
                <ul id="folderList"></ul>
            </div>
            <div>
                <strong>Delete Folder:</strong><br>
                <input type="text" id="deleteFolderName" placeholder="Enter folder name...">
                <button onclick="deleteFolder()">Delete</button>
            </div>
            <div></div>
            <div>
                <strong>Import / Export:</strong><br>
                <button onclick="importData()">Import Data...</button>
                <hr>
                <button onclick="exportData()">Export Data...</button>
                <div id="progress"></div>
            </div>
            <div>
                <input type="checkbox" id="c1"><label for="c1">Cookies</label><br>
                <input type="checkbox" id="c2" checked><label for="c2">localStorage</label><br>
                <input type="checkbox" id="c3" checked><label for="c3">IndexedDB</label><br>
                <input type="checkbox" id="c4" checked><label for="c4">RuntimeFS</label><br>
                <input type="checkbox" id="c5" checked><label for="c5">OPFS</label><br>
                <input type="checkbox" id="c6"><label for="c6">Cache Storage</label><br>
                <input type="checkbox" id="c7"><label for="c7">Session Storage</label><br>
            </div>
        </div>
    </fieldset>

    <fieldset>
        <legend>
            <h2>Advanced</h2>
        </legend>

        <h3>Regex Replacement</h3>
        Spaces required; disabled for files over 10MiB. File name matching uses regex.
        <br>
        Replace | with || and $ with $$ to only match the first instance.
        Replace regexHere or plain text with <code>{{SCRIPT}}</code> to inject a script into the HTML.
        <ul>
            <li><code>* | regexHere -> replacement</code></li>
            <li><code>file\.js $ plain text -> replacement</code></li>
            <li><code>index\.html $ {{SCRIPT}} -> alert(1)</code></li>
        </ul>
        <textarea id="regex" rows="5" cols="40" placeholder="Enter rules here..."></textarea>
        <hr>
        <h3>Custom Headers</h3>
        To use regex without replacing * with .* and escaping ., replace -> with --&gt;.
        <ul>
            <li><code># Override the default headers for network requests.</code></li>
            <li><code>* -> Cross-Origin-Embedder-Policy: require-corp</code></li>
            <li><code>index\.(html|js) --&gt; Cross-Origin-Opener-Policy: same-origin</code></li>
            <li><code>*.html -> Content-Security-Policy: default-src 'self'; worker-src 'self' blob:;</code></li>
        </ul>
        <textarea id="headers" rows="5" cols="40" placeholder="Enter headers here..."></textarea>
        <div id="encryptionSection">
            <hr>
            <h3>Encrypt Folders</h3>
            You can encrypt a folder into a bunch of files.
            <br><br>
            <label for="encryptFolderName">Folder Name:</label>
            <input type="text" id="encryptFolderName" placeholder="Enter a name...">
            <br>
            <button onclick="uploadAndEncryptWithPassword()">Password Encrypt Folder (in-browser)</button>
        </div>
    </fieldset>
</body>

</html>