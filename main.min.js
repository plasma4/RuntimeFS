/*
Copyright © 2025-2026 Leo Zhang

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
---
MIT License

Copyright (c) 2020 Kris Zyp

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CBOR={})}(this,(function(e){"use strict";let t,r,n;try{t=new TextDecoder}catch(e){}let i=0;const s={};let o,a,l,f,u,c,d,h=11281e4,y=1681e4,p={},g=0,w=0,b=[],m=[],A={useRecords:!1,mapsAsObjects:!0},v=!1,O=2;try{new Function("")}catch(e){O=1/0}class k{constructor(e){if(e&&(!e.keyMap&&!e._keyMap||e.useRecords||(e.useRecords=!1,e.mapsAsObjects=!0),!1===e.useRecords&&void 0===e.mapsAsObjects&&(e.mapsAsObjects=!0),e.getStructures&&(e.getShared=e.getStructures),e.getShared&&!e.structures&&((e.structures=[]).uninitialized=!0),e.keyMap)){this.mapKey=new Map;for(let[t,r]of Object.entries(e.keyMap))this.mapKey.set(r,t)}Object.assign(this,e)}decodeKey(e){return this.keyMap&&this.mapKey.get(e)||e}encodeKey(e){return this.keyMap&&this.keyMap.hasOwnProperty(e)?this.keyMap[e]:e}encodeKeys(e){if(!this._keyMap)return e;let t=new Map;for(let[r,n]of Object.entries(e))t.set(this._keyMap.hasOwnProperty(r)?this._keyMap[r]:r,n);return t}decodeKeys(e){if(!this._keyMap||"Map"!=e.constructor.name)return e;if(!this._mapKey){this._mapKey=new Map;for(let[e,t]of Object.entries(this._keyMap))this._mapKey.set(t,e)}let t={};return e.forEach(((e,r)=>t[M(this._mapKey.has(r)?this._mapKey.get(r):r)]=e)),t}mapDecode(e,t){let r=this.decode(e);return this._keyMap&&"Array"===r.constructor.name?r.map((e=>this.decodeKeys(e))):r}decode(e,t){if(r)return H((()=>(Y(),this?this.decode(e,t):k.prototype.decode.call(A,e,t))));n=t>-1?t:e.length,i=0,w=0,a=null,l=null,r=e;try{c=e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))}catch(t){if(r=null,e instanceof Uint8Array)throw t;throw new Error("Source must be a Uint8Array or Buffer but was a "+(e&&"object"==typeof e?e.constructor.name:typeof e))}if(this instanceof k){if(p=this,u=this.sharedValues&&(this.pack?new Array(this.maxPrivatePackedValues||16).concat(this.sharedValues):this.sharedValues),this.structures)return o=this.structures,E();(!o||o.length>0)&&(o=[])}else p=A,(!o||o.length>0)&&(o=[]),u=null;return E()}decodeMultiple(e,t){let r,n=0;try{let s=e.length;v=!0;let o=this?this.decode(e,s):Z.decode(e,s);if(!t){for(r=[o];i<s;)n=i,r.push(E());return r}if(!1===t(o))return;for(;i<s;)if(n=i,!1===t(E()))return}catch(e){throw e.lastPosition=n,e.values=r,e}finally{v=!1,Y()}}}function E(){try{let e=I();if(l){if(i>=l.postBundlePosition){let e=new Error("Unexpected bundle position");throw e.incomplete=!0,e}i=l.postBundlePosition,l=null}if(i==n)o=null,r=null,f&&(f=null);else{if(i>n){let e=new Error("Unexpected end of CBOR data");throw e.incomplete=!0,e}if(!v)throw new Error("Data read, but end of buffer not reached")}return e}catch(e){throw Y(),(e instanceof RangeError||e.message.startsWith("Unexpected end of buffer"))&&(e.incomplete=!0),e}}function I(){let e=r[i++],t=e>>5;if(e&=31,e>23)switch(e){case 24:e=r[i++];break;case 25:if(7==t)return function(){let e=r[i++],t=r[i++],n=(127&e)>>2;if(31===n)return t||3&e?NaN:128&e?-1/0:1/0;if(0===n){let r=((3&e)<<8|t)/(1<<24);return 128&e?-r:r}return _[3]=128&e|56+(n>>1),_[2]=(7&e)<<5|t>>3,_[1]=t<<5,_[0]=0,P[0]}();e=c.getUint16(i),i+=2;break;case 26:if(7==t){let e=c.getFloat32(i);if(p.useFloat32>2){let t=q[(127&r[i])<<1|r[i+1]>>7];return i+=4,(t*e+(e>0?.5:-.5)>>0)/t}return i+=4,e}e=c.getUint32(i),i+=4;break;case 27:if(7==t){let e=c.getFloat64(i);return i+=8,e}if(t>1){if(c.getUint32(i)>0)throw new Error("JavaScript does not support arrays, maps, or strings with length over 4294967295");e=c.getUint32(i+4)}else p.int64AsNumber?(e=4294967296*c.getUint32(i),e+=c.getUint32(i+4)):e=c.getBigUint64(i);i+=8;break;case 31:switch(t){case 2:case 3:throw new Error("Indefinite length not supported for byte or text strings");case 4:let e,r=[],n=0;for(;(e=I())!=s;){if(n>=h)throw new Error(`Array length exceeds ${h}`);r[n++]=e}return 4==t?r:3==t?r.join(""):Buffer.concat(r);case 5:let i;if(p.mapsAsObjects){let e={},t=0;if(p.keyMap)for(;(i=I())!=s;){if(t++>=y)throw new Error(`Property count exceeds ${y}`);e[M(p.decodeKey(i))]=I()}else for(;(i=I())!=s;){if(t++>=y)throw new Error(`Property count exceeds ${y}`);e[M(i)]=I()}return e}{d&&(p.mapsAsObjects=!0,d=!1);let e=new Map;if(p.keyMap){let t=0;for(;(i=I())!=s;){if(t++>=y)throw new Error(`Map size exceeds ${y}`);e.set(p.decodeKey(i),I())}}else{let t=0;for(;(i=I())!=s;){if(t++>=y)throw new Error(`Map size exceeds ${y}`);e.set(i,I())}}return e}case 7:return s;default:throw new Error("Invalid major type for indefinite length "+t)}default:throw new Error("Unknown token "+e)}switch(t){case 0:return e;case 1:return~e;case 2:return f=e,p.copyBuffers?Uint8Array.prototype.slice.call(r,i,i+=f):r.subarray(i,i+=f);case 3:if(w>=i)return a.slice(i-g,(i+=e)-g);if(0==w&&n<140&&e<32){let t=e<16?V(e):function(e){let t=i,n=new Array(e);for(let s=0;s<e;s++){const e=r[i++];if((128&e)>0)return void(i=t);n[s]=e}return B.apply(String,n)}(e);if(null!=t)return t}return x(e);case 4:if(e>=h)throw new Error(`Array length exceeds ${h}`);let t=new Array(e);for(let r=0;r<e;r++)t[r]=I();return t;case 5:if(e>=y)throw new Error(`Map size exceeds ${h}`);if(p.mapsAsObjects){let t={};if(p.keyMap)for(let r=0;r<e;r++)t[M(p.decodeKey(I()))]=I();else for(let r=0;r<e;r++)t[M(I())]=I();return t}{d&&(p.mapsAsObjects=!0,d=!1);let t=new Map;if(p.keyMap)for(let r=0;r<e;r++)t.set(p.decodeKey(I()),I());else for(let r=0;r<e;r++)t.set(I(),I());return t}case 6:if(e>=57337){let t=o[8191&e];if(t)return t.read||(t.read=S(t)),t.read();if(e<65536){if(57343==e){let e=$(),t=I(),r=I();F(t,r);let n={};if(p.keyMap)for(let t=2;t<e;t++){n[M(p.decodeKey(r[t-2]))]=I()}else for(let t=2;t<e;t++){n[M(r[t-2])]=I()}return n}if(57342==e){let e=$(),t=I();for(let r=2;r<e;r++)F(t++,I());return I()}if(57337==e)return function(){let e=$(),t=i+I();for(let t=2;t<e;t++){let e=$();i+=e}let r=i;return i=t,l=[j($()),j($())],l.position0=0,l.position1=0,l.postBundlePosition=i,i=r,I()}();if(p.getShared&&(J(),t=o[8191&e],t))return t.read||(t.read=S(t)),t.read()}}let s=b[e];if(s)return s.handlesRead?s(I):s(I());{let t=I();for(let r=0;r<m.length;r++){let n=m[r](e,t);if(void 0!==n)return n}return new R(t,e)}case 7:switch(e){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;default:let t=(u||K())[e];if(void 0!==t)return t;throw new Error("Unknown token "+e)}default:if(isNaN(e)){let e=new Error("Unexpected end of CBOR data");throw e.incomplete=!0,e}throw new Error("Unknown CBOR token "+e)}var f}const U=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function S(e){if(!e)throw new Error("Structure is required in record definition");return e.slowReads=0,function(){let e=r[i++];if(e&=31,e>23)switch(e){case 24:e=r[i++];break;case 25:e=c.getUint16(i),i+=2;break;case 26:e=c.getUint32(i),i+=4;break;default:throw new Error("Expected array header, but got "+r[i-1])}let t=this.compiledReader;for(;t;){if(t.propertyCount===e)return t(I);t=t.next}if(this.slowReads++>=O){let r=this.length==e?this:this.slice(0,e);return t=p.keyMap?new Function("r","return {"+r.map((e=>p.decodeKey(e))).map((e=>U.test(e)?M(e)+":r()":"["+JSON.stringify(e)+"]:r()")).join(",")+"}"):new Function("r","return {"+r.map((e=>U.test(e)?M(e)+":r()":"["+JSON.stringify(e)+"]:r()")).join(",")+"}"),this.compiledReader&&(t.next=this.compiledReader),t.propertyCount=e,this.compiledReader=t,t(I)}let n={};if(p.keyMap)for(let t=0;t<e;t++)n[M(p.decodeKey(this[t]))]=I();else for(let t=0;t<e;t++)n[M(this[t])]=I();return n}}function M(e){if("string"==typeof e)return"__proto__"===e?"__proto_":e;if("number"==typeof e||"boolean"==typeof e||"bigint"==typeof e)return e.toString();if(null==e)return e+"";throw new Error("Invalid property name type "+typeof e)}let x=j;function j(e){let n;if(e<16&&(n=V(e)))return n;if(e>64&&t)return t.decode(r.subarray(i,i+=e));const s=i+e,o=[];for(n="";i<s;){const e=r[i++];if(0==(128&e))o.push(e);else if(192==(224&e)){const t=63&r[i++];o.push((31&e)<<6|t)}else if(224==(240&e)){const t=63&r[i++],n=63&r[i++];o.push((31&e)<<12|t<<6|n)}else if(240==(248&e)){let t=(7&e)<<18|(63&r[i++])<<12|(63&r[i++])<<6|63&r[i++];t>65535&&(t-=65536,o.push(t>>>10&1023|55296),t=56320|1023&t),o.push(t)}else o.push(e);o.length>=4096&&(n+=B.apply(String,o),o.length=0)}return o.length>0&&(n+=B.apply(String,o)),n}let B=String.fromCharCode;function V(e){if(e<4){if(e<2){if(0===e)return"";{let e=r[i++];return(128&e)>1?void(i-=1):B(e)}}{let t=r[i++],n=r[i++];if((128&t)>0||(128&n)>0)return void(i-=2);if(e<3)return B(t,n);let s=r[i++];return(128&s)>0?void(i-=3):B(t,n,s)}}{let t=r[i++],n=r[i++],s=r[i++],o=r[i++];if((128&t)>0||(128&n)>0||(128&s)>0||(128&o)>0)return void(i-=4);if(e<6){if(4===e)return B(t,n,s,o);{let e=r[i++];return(128&e)>0?void(i-=5):B(t,n,s,o,e)}}if(e<8){let a=r[i++],l=r[i++];if((128&a)>0||(128&l)>0)return void(i-=6);if(e<7)return B(t,n,s,o,a,l);let f=r[i++];return(128&f)>0?void(i-=7):B(t,n,s,o,a,l,f)}{let a=r[i++],l=r[i++],f=r[i++],u=r[i++];if((128&a)>0||(128&l)>0||(128&f)>0||(128&u)>0)return void(i-=8);if(e<10){if(8===e)return B(t,n,s,o,a,l,f,u);{let e=r[i++];return(128&e)>0?void(i-=9):B(t,n,s,o,a,l,f,u,e)}}if(e<12){let c=r[i++],d=r[i++];if((128&c)>0||(128&d)>0)return void(i-=10);if(e<11)return B(t,n,s,o,a,l,f,u,c,d);let h=r[i++];return(128&h)>0?void(i-=11):B(t,n,s,o,a,l,f,u,c,d,h)}{let c=r[i++],d=r[i++],h=r[i++],y=r[i++];if((128&c)>0||(128&d)>0||(128&h)>0||(128&y)>0)return void(i-=12);if(e<14){if(12===e)return B(t,n,s,o,a,l,f,u,c,d,h,y);{let e=r[i++];return(128&e)>0?void(i-=13):B(t,n,s,o,a,l,f,u,c,d,h,y,e)}}{let p=r[i++],g=r[i++];if((128&p)>0||(128&g)>0)return void(i-=14);if(e<15)return B(t,n,s,o,a,l,f,u,c,d,h,y,p,g);let w=r[i++];return(128&w)>0?void(i-=15):B(t,n,s,o,a,l,f,u,c,d,h,y,p,g,w)}}}}}let P=new Float32Array(1),_=new Uint8Array(P.buffer,0,4);new Array(4096);class R{constructor(e,t){this.value=e,this.tag=t}}b[0]=e=>new Date(e),b[1]=e=>new Date(Math.round(1e3*e)),b[2]=e=>{let t=BigInt(0);for(let r=0,n=e.byteLength;r<n;r++)t=BigInt(e[r])+(t<<BigInt(8));return t},b[3]=e=>BigInt(-1)-b[2](e),b[4]=e=>+(e[1]+"e"+e[0]),b[5]=e=>e[1]*Math.exp(e[0]*Math.log(2));const F=(e,t)=>{let r=o[e-=57344];r&&r.isShared&&((o.restoreStructures||(o.restoreStructures=[]))[e]=r),o[e]=t,t.read=S(t)};b[105]=e=>{let t=e.length,r=e[1];F(e[0],r);let n={};for(let i=2;i<t;i++){n[M(r[i-2])]=e[i]}return n},b[14]=e=>l?l[0].slice(l.position0,l.position0+=e):new R(e,14),b[15]=e=>l?l[1].slice(l.position1,l.position1+=e):new R(e,15);let T={Error:Error,RegExp:RegExp};b[27]=e=>(T[e[0]]||Error)(e[1],e[2]);const D=e=>{if(132!=r[i++]){let e=new Error("Packed values structure must be followed by a 4 element array");throw r.length<i&&(e.incomplete=!0),e}let t=e();if(!t||!t.length){let e=new Error("Packed values structure must be followed by a 4 element array");throw e.incomplete=!0,e}return u=u?t.concat(u.slice(t.length)):t,u.prefixes=e(),u.suffixes=e(),e()};function N(e,t){return"string"==typeof e?e+t:e instanceof Array?e.concat(t):Object.assign({},e,t)}function K(){if(!u){if(!p.getShared)throw new Error("No packed values available");J()}return u}D.handlesRead=!0,b[51]=D,b[6]=e=>{if(!u){if(!p.getShared)return new R(e,6);J()}if("number"==typeof e)return u[16+(e>=0?2*e:-2*e-1)];let t=new Error("No support for non-integer packed references yet");throw void 0===e&&(t.incomplete=!0),t},b[28]=e=>{f||(f=new Map,f.id=0);let t,n=f.id++,s=i;t=r[i]>>5==4?[]:{};let o={target:t};f.set(n,o);let a=e();return o.used?(Object.getPrototypeOf(t)!==Object.getPrototypeOf(a)&&(i=s,t=a,f.set(n,{target:t}),a=e()),Object.assign(t,a)):(o.target=a,a)},b[28].handlesRead=!0,b[29]=e=>{let t=f.get(e);return t.used=!0,t.target},b[258]=e=>new Set(e),(b[259]=e=>(p.mapsAsObjects&&(p.mapsAsObjects=!1,d=!0),e())).handlesRead=!0;m.push(((e,t)=>e>=225&&e<=255?N(K().prefixes[e-224],t):e>=28704&&e<=32767?N(K().prefixes[e-28672],t):e>=1879052288&&e<=2147483647?N(K().prefixes[e-1879048192],t):e>=216&&e<=223?N(t,K().suffixes[e-216]):e>=27647&&e<=28671?N(t,K().suffixes[e-27639]):e>=1811940352&&e<=1879048191?N(t,K().suffixes[e-1811939328]):1399353956==e?{packedValues:u,structures:o.slice(0),version:t}:55799==e?t:void 0));const C=1==new Uint8Array(new Uint16Array([1]).buffer)[0],z=[Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,"undefined"==typeof BigUint64Array?{name:"BigUint64Array"}:BigUint64Array,Int8Array,Int16Array,Int32Array,"undefined"==typeof BigInt64Array?{name:"BigInt64Array"}:BigInt64Array,Float32Array,Float64Array],L=[64,68,69,70,71,72,77,78,79,85,86];for(let e=0;e<z.length;e++)W(z[e],L[e]);function W(e,t){let r,n="get"+e.name.slice(0,-5);"function"==typeof e?r=e.BYTES_PER_ELEMENT:e=null;for(let i=0;i<2;i++){if(!i&&1==r)continue;let s=2==r?1:4==r?2:8==r?3:0;b[i?t:t-4]=1==r||i==C?n=>{if(!e)throw new Error("Could not find typed array for code "+t);return p.copyBuffers||1!==r&&(2!==r||1&n.byteOffset)&&(4!==r||3&n.byteOffset)&&(8!==r||7&n.byteOffset)?new e(Uint8Array.prototype.slice.call(n,0).buffer):new e(n.buffer,n.byteOffset,n.byteLength>>s)}:r=>{if(!e)throw new Error("Could not find typed array for code "+t);let o=new DataView(r.buffer,r.byteOffset,r.byteLength),a=r.length>>s,l=new e(a),f=o[n];for(let e=0;e<a;e++)l[e]=f.call(o,e<<s,i);return l}}}function $(){let e=31&r[i++];if(e>23)switch(e){case 24:e=r[i++];break;case 25:e=c.getUint16(i),i+=2;break;case 26:e=c.getUint32(i),i+=4}return e}function J(){if(p.getShared){let e=H((()=>(r=null,p.getShared())))||{},t=e.structures||[];p.sharedVersion=e.version,u=p.sharedValues=e.packedValues,!0===o?p.structures=o=t:o.splice.apply(o,[0,t.length].concat(t))}}function H(e){let t=n,s=i,u=g,d=w,h=a,y=f,b=l,m=new Uint8Array(r.slice(0,n)),A=o,O=p,k=v,E=e();return n=t,i=s,g=u,w=d,a=h,f=y,l=b,r=m,v=k,o=A,p=O,c=new DataView(r.buffer,r.byteOffset,r.byteLength),E}function Y(){r=null,f=null,o=null}const q=new Array(147);for(let e=0;e<256;e++)q[e]=+("1e"+Math.floor(45.15-.30103*e));let Z=new k({useRecords:!1});const G=Z.decode,Q=Z.decodeMultiple,X={NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4};let ee,te,re;try{ee=new TextEncoder}catch(e){}const ne="object"==typeof globalThis&&globalThis.Buffer,ie=void 0!==ne,se=ie?ne.allocUnsafeSlow:Uint8Array,oe=ie?ne:Uint8Array,ae=ie?4294967296:2144337920;let le,fe,ue,ce,de=0,he=null;const ye=/[\u0080-\uFFFF]/,pe=Symbol("record-id");class ge extends k{constructor(e){let t,r,n,i,s;super(e),this.offset=0,e=e||{};let o=oe.prototype.utf8Write?function(e,t,r){return fe.utf8Write(e,t,r)}:!(!ee||!ee.encodeInto)&&function(e,t){return ee.encodeInto(e,fe.subarray(t)).written},a=this,l=e.structures||e.saveStructures,f=e.maxSharedStructures;if(null==f&&(f=l?128:0),f>8190)throw new Error("Maximum maxSharedStructure is 8190");let u=e.sequential;u&&(f=0),this.structures||(this.structures=[]),this.saveStructures&&(this.saveShared=this.saveStructures);let c,d,h,y=e.sharedValues;if(y){h=Object.create(null);for(let e=0,t=y.length;e<t;e++)h[y[e]]=e}let p=[],g=0,w=0;this.mapEncode=function(e,t){if(this._keyMap&&!this._mapped&&"Array"===e.constructor.name)e=e.map((e=>this.encodeKeys(e)));return this.encode(e,t)},this.encode=function(o,l){if(fe||(fe=new se(8192),ue=new DataView(fe.buffer,0,8192),de=0),ce=fe.length-10,ce-de<2048?(fe=new se(fe.length),ue=new DataView(fe.buffer,0,fe.length),ce=fe.length-10,de=0):l===Re&&(de=de+7&2147483640),t=de,a.useSelfDescribedHeader&&(ue.setUint32(de,3654940416),de+=3),s=a.structuredClone?new Map:null,a.bundleStrings&&"string"!=typeof o?(he=[],he.size=1/0):he=null,r=a.structures,r){if(r.uninitialized){let e=a.getShared()||{};a.structures=r=e.structures||[],a.sharedVersion=e.version;let t=a.sharedValues=e.packedValues;if(t){h={};for(let e=0,r=t.length;e<r;e++)h[t[e]]=e}}let e=r.length;if(e>f&&!u&&(e=f),!r.transitions){r.transitions=Object.create(null);for(let t=0;t<e;t++){let e=r[t];if(!e)continue;let n,i=r.transitions;for(let r=0,s=e.length;r<s;r++){void 0===i[pe]&&(i[pe]=t);let s=e[r];n=i[s],n||(n=i[s]=Object.create(null)),i=n}i[pe]=1048576|t}}u||(r.nextId=e)}if(n&&(n=!1),i=r||[],d=h,e.pack){let t=new Map;if(t.values=[],t.encoder=a,t.maxValues=e.maxPrivatePackedValues||(h?16:1/0),t.objectMap=h||!1,t.samplingPackedValues=c,Oe(o,t),t.values.length>0){fe[de++]=216,fe[de++]=51,me(4);let e=t.values;b(e),me(0),me(0),d=Object.create(h||null);for(let t=0,r=e.length;t<r;t++)d[e[t]]=t}}le=l&Te;try{if(le)return;if(b(o),he&&Ue(t,b),a.offset=de,s&&s.idsToInsert){de+=2*s.idsToInsert.length,de>ce&&A(de),a.offset=de;let e=function(e,t){let r,n=2*t.length,i=e.length-n;t.sort(((e,t)=>e.offset>t.offset?1:-1));for(let r=0;r<t.length;r++){let n=t[r];n.id=r;for(let t of n.references)e[t++]=r>>8,e[t]=255&r}for(;r=t.pop();){let t=r.offset;e.copyWithin(t+n,t,i),n-=2;let s=t+n;e[s++]=216,e[s++]=28,i=t}return e}(fe.subarray(t,de),s.idsToInsert);return s=null,e}return l&Re?(fe.start=t,fe.end=de,fe):fe.subarray(t,de)}finally{if(r)if(w<10&&w++,r.length>f&&(r.length=f),g>1e4)r.transitions=null,w=0,g=0,p.length>0&&(p=[]);else if(p.length>0&&!u){for(let e=0,t=p.length;e<t;e++)p[e][pe]=void 0;p=[]}if(n&&a.saveShared){a.structures.length>f&&(a.structures=a.structures.slice(0,f));let e=fe.subarray(t,de);return!1===a.updateSharedData()?a.encode(o):e}l&Fe&&(de=t)}},this.findCommonStringsToPack=()=>(c=new Map,h||(h=Object.create(null)),e=>{let t=e&&e.threshold||4,r=this.pack?e.maxPrivatePackedValues||16:0;y||(y=this.sharedValues=[]);for(let[e,i]of c)i.count>t&&(h[e]=r++,y.push(e),n=!0);for(;this.saveShared&&!1===this.updateSharedData(););c=null});const b=r=>{de>ce&&(fe=A(de));var n,i=typeof r;if("string"===i){if(d){let t=d[r];if(t>=0)return void(t<16?fe[de++]=t+224:(fe[de++]=198,b(1&t?15-t>>1:t-16>>1)));if(c&&!e.pack){let e=c.get(r);e?e.count++:c.set(r,{count:1})}}let i,s=r.length;if(he&&s>=4&&s<1024){if((he.size+=s)>61440){let e,r=(he[0]?3*he[0].length+he[1].length:0)+10;de+r>ce&&(fe=A(de+r)),fe[de++]=217,fe[de++]=223,fe[de++]=249,fe[de++]=he.position?132:130,fe[de++]=26,e=de-t,de+=4,he.position&&Ue(t,b),he=["",""],he.size=0,he.position=e}let e=ye.test(r);return he[e?0:1]+=r,fe[de++]=e?206:207,void b(s)}i=s<32?1:s<256?2:s<65536?3:5;let a=3*s;if(de+a>ce&&(fe=A(de+a)),s<64||!o){let e,t,o,a=de+i;for(e=0;e<s;e++)t=r.charCodeAt(e),t<128?fe[a++]=t:t<2048?(fe[a++]=t>>6|192,fe[a++]=63&t|128):55296==(64512&t)&&56320==(64512&(o=r.charCodeAt(e+1)))?(t=65536+((1023&t)<<10)+(1023&o),e++,fe[a++]=t>>18|240,fe[a++]=t>>12&63|128,fe[a++]=t>>6&63|128,fe[a++]=63&t|128):(fe[a++]=t>>12|224,fe[a++]=t>>6&63|128,fe[a++]=63&t|128);n=a-de-i}else n=o(r,de+i,a);n<24?fe[de++]=96|n:n<256?(i<2&&fe.copyWithin(de+2,de+1,de+1+n),fe[de++]=120,fe[de++]=n):n<65536?(i<3&&fe.copyWithin(de+3,de+2,de+2+n),fe[de++]=121,fe[de++]=n>>8,fe[de++]=255&n):(i<5&&fe.copyWithin(de+5,de+3,de+3+n),fe[de++]=122,ue.setUint32(de,n),de+=4),de+=n}else if("number"===i)if(this.alwaysUseFloat||r>>>0!==r)if(this.alwaysUseFloat||r>>0!==r){let e;if((e=this.useFloat32)>0&&r<4294967296&&r>=-2147483648){let t;if(fe[de++]=250,ue.setFloat32(de,r),e<4||(t=r*q[(127&fe[de])<<1|fe[de+1]>>7])>>0===t)return void(de+=4);de--}fe[de++]=251,ue.setFloat64(de,r),de+=8}else r>=-24?fe[de++]=31-r:r>=-256?(fe[de++]=56,fe[de++]=~r):r>=-65536?(fe[de++]=57,ue.setUint16(de,~r),de+=2):(fe[de++]=58,ue.setUint32(de,~r),de+=4);else r<24?fe[de++]=r:r<256?(fe[de++]=24,fe[de++]=r):r<65536?(fe[de++]=25,fe[de++]=r>>8,fe[de++]=255&r):(fe[de++]=26,ue.setUint32(de,r),de+=4);else if("object"===i)if(r){if(s){let e=s.get(r);if(e){if(fe[de++]=216,fe[de++]=29,fe[de++]=25,!e.references){let t=s.idsToInsert||(s.idsToInsert=[]);e.references=[],t.push(e)}return e.references.push(de-t),void(de+=2)}s.set(r,{offset:de-t})}let e=r.constructor;if(e===Object)m(r);else if(e===Array){(n=r.length)<24?fe[de++]=128|n:me(n);for(let e=0;e<n;e++)b(r[e])}else if(e===Map)if((this.mapsAsObjects?!1!==this.useTag259ForMaps:this.useTag259ForMaps)&&(fe[de++]=217,fe[de++]=1,fe[de++]=3),(n=r.size)<24?fe[de++]=160|n:n<256?(fe[de++]=184,fe[de++]=n):n<65536?(fe[de++]=185,fe[de++]=n>>8,fe[de++]=255&n):(fe[de++]=186,ue.setUint32(de,n),de+=4),a.keyMap)for(let[e,t]of r)b(a.encodeKey(e)),b(t);else for(let[e,t]of r)b(e),b(t);else{for(let e=0,t=te.length;e<t;e++){if(r instanceof re[e]){let t=te[e],n=t.tag;return null==n&&(n=t.getTag&&t.getTag.call(this,r)),n<24?fe[de++]=192|n:n<256?(fe[de++]=216,fe[de++]=n):n<65536?(fe[de++]=217,fe[de++]=n>>8,fe[de++]=255&n):n>-1&&(fe[de++]=218,ue.setUint32(de,n),de+=4),void t.encode.call(this,r,b,A)}}if(r[Symbol.iterator]){if(le){let e=new Error("Iterable should be serialized as iterator");throw e.iteratorNotHandled=!0,e}fe[de++]=159;for(let e of r)b(e);return void(fe[de++]=255)}if(r[Symbol.asyncIterator]||ve(r)){let e=new Error("Iterable/blob should be serialized as iterator");throw e.iteratorNotHandled=!0,e}if(this.useToJSON&&r.toJSON){const e=r.toJSON();if(e!==r)return b(e)}m(r)}}else fe[de++]=246;else if("boolean"===i)fe[de++]=r?245:244;else if("bigint"===i){if(r<BigInt(1)<<BigInt(64)&&r>=0)fe[de++]=27,ue.setBigUint64(de,r);else if(r>-(BigInt(1)<<BigInt(64))&&r<0)fe[de++]=59,ue.setBigUint64(de,-r-BigInt(1));else{if(!this.largeBigIntToFloat){r>=BigInt(0)?fe[de++]=194:(fe[de++]=195,r=BigInt(-1)-r);let e=[];for(;r;)e.push(Number(r&BigInt(255))),r>>=BigInt(8);return void Ie(new Uint8Array(e.reverse()),A)}fe[de++]=251,ue.setFloat64(de,Number(r))}de+=8}else{if("undefined"!==i)throw new Error("Unknown type: "+i);fe[de++]=247}},m=!1===this.useRecords?this.variableMapSize?e=>{let t=Object.keys(e),r=Object.values(e),n=t.length;if(n<24?fe[de++]=160|n:n<256?(fe[de++]=184,fe[de++]=n):n<65536?(fe[de++]=185,fe[de++]=n>>8,fe[de++]=255&n):(fe[de++]=186,ue.setUint32(de,n),de+=4),a.keyMap)for(let e=0;e<n;e++)b(a.encodeKey(t[e])),b(r[e]);else for(let e=0;e<n;e++)b(t[e]),b(r[e])}:e=>{fe[de++]=185;let r=de-t;de+=2;let n=0;if(a.keyMap)for(let t in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&(b(a.encodeKey(t)),b(e[t]),n++);else for(let t in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&(b(t),b(e[t]),n++);fe[r+++t]=n>>8,fe[r+t]=255&n}:(e,t)=>{let r,s,o,a=i.transitions||(i.transitions=Object.create(null)),l=0,u=0;if(this.keyMap){o=Object.keys(e).map((e=>this.encodeKey(e))),u=o.length;for(let e=0;e<u;e++){let t=o[e];r=a[t],r||(r=a[t]=Object.create(null),l++),a=r}}else for(let t in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&(r=a[t],r||(1048576&a[pe]&&(s=65535&a[pe]),r=a[t]=Object.create(null),l++),a=r,u++);let c=a[pe];if(void 0!==c)c&=65535,fe[de++]=217,fe[de++]=c>>8|224,fe[de++]=255&c;else{if(o||(o=a.__keys__||(a.__keys__=Object.keys(e))),void 0===s?(c=i.nextId++,c||(c=0,i.nextId=1),c>=256&&(i.nextId=(c=f)+1)):c=s,i[c]=o,!(c<f)){if(a[pe]=c,ue.setUint32(de,3655335680),de+=3,l&&(g+=w*l),p.length>=256-f&&(p.shift()[pe]=void 0),p.push(a),me(u+2),b(57344+c),b(o),t)return;for(let t in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&b(e[t]);return}fe[de++]=217,fe[de++]=c>>8|224,fe[de++]=255&c,a=i.transitions;for(let e=0;e<u;e++)(void 0===a[pe]||1048576&a[pe])&&(a[pe]=c),a=a[o[e]];a[pe]=1048576|c,n=!0}if(u<24?fe[de++]=128|u:me(u),!t)for(let t in e)("function"!=typeof e.hasOwnProperty||e.hasOwnProperty(t))&&b(e[t])},A=e=>{let r;if(e>16777216){if(e-t>ae)throw new Error("Encoded buffer would be larger than maximum buffer size");r=Math.min(ae,4096*Math.round(Math.max((e-t)*(e>67108864?1.25:2),4194304)/4096))}else r=1+(Math.max(e-t<<2,fe.length-1)>>12)<<12;let n=new se(r);return ue=new DataView(n.buffer,0,r),fe.copy?fe.copy(n,0,t,e):n.set(fe.slice(t,e)),de-=t,t=0,ce=n.length-10,fe=n};let v=100,O=1e3;function*k(e,r,n){let i=e.constructor;if(i===Object){let t=!1!==a.useRecords;t?m(e,!0):we(Object.keys(e).length,160);for(let n in e){let i=e[n];t||b(n),i&&"object"==typeof i?r[n]?yield*k(i,r[n]):yield*E(i,r,n):b(i)}}else if(i===Array){let n=e.length;me(n);for(let i=0;i<n;i++){let n=e[i];n&&("object"==typeof n||de-t>v)?r.element?yield*k(n,r.element):yield*E(n,r,"element"):b(n)}}else if(e[Symbol.iterator]&&!e.buffer){fe[de++]=159;for(let n of e)n&&("object"==typeof n||de-t>v)?r.element?yield*k(n,r.element):yield*E(n,r,"element"):b(n);fe[de++]=255}else ve(e)?(we(e.size,64),yield fe.subarray(t,de),yield e,I()):e[Symbol.asyncIterator]?(fe[de++]=159,yield fe.subarray(t,de),yield e,I(),fe[de++]=255):b(e);n&&de>t?yield fe.subarray(t,de):de-t>v&&(yield fe.subarray(t,de),I())}function*E(e,r,n){let i=de-t;try{b(e),de-t>v&&(yield fe.subarray(t,de),I())}catch(s){if(!s.iteratorNotHandled)throw s;r[n]={},de=t+i,yield*k.call(this,e,r[n])}}function I(){v=O,a.encode(null,Te)}function U(e,t,r){return v=t&&t.chunkThreshold?O=t.chunkThreshold:100,e&&"object"==typeof e?(a.encode(null,Te),r(e,a.iterateProperties||(a.iterateProperties={}),!0)):[a.encode(e)]}async function*S(e,t){for(let r of k(e,t,!0)){let e=r.constructor;if(e===oe||e===Uint8Array)yield r;else if(ve(r)){let e,t=r.stream().getReader();for(;!(e=await t.read()).done;)yield e.value}else if(r[Symbol.asyncIterator])for await(let e of r)I(),e?yield*S(e,t.async||(t.async={})):yield a.encode(e);else yield r}}this.encodeAsIterable=function(e,t){return U(e,t,k)},this.encodeAsAsyncIterable=function(e,t){return U(e,t,S)}}useBuffer(e){fe=e,ue=new DataView(fe.buffer,fe.byteOffset,fe.byteLength),de=0}clearSharedData(){this.structures&&(this.structures=[]),this.sharedValues&&(this.sharedValues=void 0)}updateSharedData(){let e=this.sharedVersion||0;this.sharedVersion=e+1;let t=this.structures.slice(0),r=new be(t,this.sharedValues,this.sharedVersion),n=this.saveShared(r,(t=>(t&&t.version||0)==e));return!1===n?(r=this.getShared()||{},this.structures=r.structures||[],this.sharedValues=r.packedValues,this.sharedVersion=r.version,this.structures.nextId=this.structures.length):t.forEach(((e,t)=>this.structures[t]=e)),n}}function we(e,t){e<24?fe[de++]=t|e:e<256?(fe[de++]=24|t,fe[de++]=e):e<65536?(fe[de++]=25|t,fe[de++]=e>>8,fe[de++]=255&e):(fe[de++]=26|t,ue.setUint32(de,e),de+=4)}class be{constructor(e,t,r){this.structures=e,this.packedValues=t,this.version=r}}function me(e){e<24?fe[de++]=128|e:e<256?(fe[de++]=152,fe[de++]=e):e<65536?(fe[de++]=153,fe[de++]=e>>8,fe[de++]=255&e):(fe[de++]=154,ue.setUint32(de,e),de+=4)}const Ae="undefined"==typeof Blob?function(){}:Blob;function ve(e){if(e instanceof Ae)return!0;let t=e[Symbol.toStringTag];return"Blob"===t||"File"===t}function Oe(e,t){switch(typeof e){case"string":if(e.length>3){if(t.objectMap[e]>-1||t.values.length>=t.maxValues)return;let r=t.get(e);if(r)2==++r.count&&t.values.push(e);else if(t.set(e,{count:1}),t.samplingPackedValues){let r=t.samplingPackedValues.get(e);r?r.count++:t.samplingPackedValues.set(e,{count:1})}}break;case"object":if(e)if(e instanceof Array)for(let r=0,n=e.length;r<n;r++)Oe(e[r],t);else{let n=!t.encoder.useRecords;for(var r in e)e.hasOwnProperty(r)&&(n&&Oe(r,t),Oe(e[r],t))}break;case"function":console.log(e)}}const ke=1==new Uint8Array(new Uint16Array([1]).buffer)[0];function Ee(e,t){return!ke&&t>1&&(e-=4),{tag:e,encode:function(e,t){let r=e.byteLength,n=e.byteOffset||0,i=e.buffer||e;t(ie?ne.from(i,n,r):new Uint8Array(i,n,r))}}}function Ie(e,t){let r=e.byteLength;r<24?fe[de++]=64+r:r<256?(fe[de++]=88,fe[de++]=r):r<65536?(fe[de++]=89,fe[de++]=r>>8,fe[de++]=255&r):(fe[de++]=90,ue.setUint32(de,r),de+=4),de+r>=fe.length&&t(de+r),fe.set(e.buffer?e:new Uint8Array(e),de),de+=r}function Ue(e,t){ue.setUint32(he.position+e,de-he.position-e+1);let r=he;he=null,t(r[0]),t(r[1])}re=[Date,Set,Error,RegExp,R,ArrayBuffer,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,"undefined"==typeof BigUint64Array?function(){}:BigUint64Array,Int8Array,Int16Array,Int32Array,"undefined"==typeof BigInt64Array?function(){}:BigInt64Array,Float32Array,Float64Array,be],te=[{tag:1,encode(e,t){let r=e.getTime()/1e3;(this.useTimestamp32||0===e.getMilliseconds())&&r>=0&&r<4294967296?(fe[de++]=26,ue.setUint32(de,r),de+=4):(fe[de++]=251,ue.setFloat64(de,r),de+=8)}},{tag:258,encode(e,t){t(Array.from(e))}},{tag:27,encode(e,t){t([e.name,e.message])}},{tag:27,encode(e,t){t(["RegExp",e.source,e.flags])}},{getTag:e=>e.tag,encode(e,t){t(e.value)}},{encode(e,t,r){Ie(e,r)}},{getTag(e){if(e.constructor===Uint8Array&&(this.tagUint8Array||ie&&!1!==this.tagUint8Array))return 64},encode(e,t,r){Ie(e,r)}},Ee(68,1),Ee(69,2),Ee(70,4),Ee(71,8),Ee(72,1),Ee(77,2),Ee(78,4),Ee(79,8),Ee(85,4),Ee(86,8),{encode(e,t){let r=e.packedValues||[],n=e.structures||[];if(r.values.length>0){fe[de++]=216,fe[de++]=51,me(4);let e=r.values;t(e),me(0),me(0),packedObjectMap=Object.create(sharedPackedObjectMap||null);for(let t=0,r=e.length;t<r;t++)packedObjectMap[e[t]]=t}if(n){ue.setUint32(de,3655335424),de+=3;let r=n.slice(0);r.unshift(57344),r.push(new R(e.version,1399353956)),t(r)}else t(new R(e.version,1399353956))}}];let Se=new ge({useRecords:!1});const Me=Se.encode,xe=Se.encodeAsIterable,je=Se.encodeAsAsyncIterable,{NEVER:Be,ALWAYS:Ve,DECIMAL_ROUND:Pe,DECIMAL_FIT:_e}=X,Re=512,Fe=1024,Te=2048;e.ALWAYS=Ve,e.DECIMAL_FIT=_e,e.DECIMAL_ROUND=Pe,e.Decoder=k,e.Encoder=ge,e.FLOAT32_OPTIONS=X,e.NEVER=Be,e.REUSE_BUFFER_MODE=Re,e.Tag=R,e.addExtension=function(e){if(e.Class){if(!e.encode)throw new Error("Extension has no encode function");re.unshift(e.Class),te.unshift(e)}!function(e){b[e.tag]=e.decode}(e)},e.clearSource=Y,e.decode=G,e.decodeIter=function(e,t={}){if(!e||"object"!=typeof e)throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a promise");const r=new k(t);let n;const i=e=>{let t;n&&(e=Buffer.concat([n,e]),n=void 0);try{t=r.decodeMultiple(e)}catch(r){if(!r.incomplete)throw r;n=e.slice(r.lastPosition),t=r.values}return t};return"function"==typeof e[Symbol.iterator]?function*(){for(const t of e)yield*i(t)}():"function"==typeof e[Symbol.asyncIterator]?async function*(){for await(const t of e)yield*i(t)}():void 0},e.decodeMultiple=Q,e.encode=Me,e.encodeAsAsyncIterable=je,e.encodeAsIterable=xe,e.encodeIter=function(e,t={}){if(e&&"object"==typeof e){if("function"==typeof e[Symbol.iterator])return function*(e,t){const r=new ge(t);for(const t of e)yield r.encode(t)}(e,t);if("function"==typeof e.then||"function"==typeof e[Symbol.asyncIterator])return async function*(e,t){const r=new ge(t);for await(const t of e)yield r.encode(t)}(e,t);throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a Promise")}throw new Error("first argument must be an Iterable, Async Iterable, or a Promise for an Async Iterable")},e.isNativeAccelerationEnabled=!1,e.roundFloat32=function(e){P[0]=e;let t=q[(127&_[3])<<1|_[2]>>7];return(t*e+(e>0?.5:-.5)>>0)/t},e.setSizeLimits=function(e){e.maxMapSize&&(y=e.maxMapSize),e.maxArraySize&&(h=e.maxArraySize),e.maxObjectSize&&e.maxObjectSize}}));
(function(){function e(e=100){async function t(){"scheduler"in window&&"yield"in scheduler?await scheduler.yield():await new Promise(e=>{o.push(e),a.port2.postMessage(null)}),r=Date.now(),n=null}let r=0,n=null;const a=new MessageChannel,o=[];return a.port1.onmessage=()=>o.shift()?.(),function(a=!1){const o=Date.now();return!a&&o-r<=e?null:(n||(n=t()),n)}}async function t(e,t){const r=await crypto.subtle.importKey("raw",y.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:6e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}function r(e,r,n){const{include:a,exclude:o}=n;if(o&&o[e]){const t=o[e];if("function"==typeof t){if(t(r))return!1;}else if(Array.isArray(t)&&t.some(e=>r===e||r.startsWith(e+"/")))return!1}if(a&&a[e]){const t=a[e];if("function"==typeof t)return t(r);if(Array.isArray(t)&&0<t.length)return t.some(e=>r.startsWith(e))}return!0}function n(e,t,r=new WeakMap,n=new Map){if(!e||"object"!=typeof e)return e;if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)||e instanceof Date)return e;if(r.has(e))return r.get(e);if(e instanceof Blob){if(n.has(e))return n.get(e);const r=(f++).toString(16);t.push({uuid:r,blob:e});const a={__le_blob_ref:r,type:e.type,size:e.size};return n.set(e,a),a}let a;if(Array.isArray(e)){const o=Object.keys(e),i=o.length<e.length||o.some(e=>isNaN(e));if(i){a={__le_type:"sparse_array",length:e.length,data:{}},r.set(e,a);for(const i of o)a.data[i]=LittleExport.prepForCBOR(e[i],t,r,n)}else{a=Array(e.length),r.set(e,a);for(let o=0;o<e.length;o++)a[o]=LittleExport.prepForCBOR(e[o],t,r,n)}}else for(const o in a={},r.set(e,a),e)Object.prototype.hasOwnProperty.call(e,o)&&(a[o]=LittleExport.prepForCBOR(e[o],t,r,n));return a}function a(e,t){const r=new TextEncoder;let n=new Uint8Array(0);const a=(e,t)=>{if(null===t||void 0===t)return;const a=` ${e}=${t+""}\n`,o=r.encode(a);let i=o.length,s=i+"";for(;;){const e=o.length+s.length;if(e===i)break;i=e,s=i+""}const d=r.encode(`${s}${a}`),c=new Uint8Array(n.length+d.length);c.set(n),c.set(d,n.length),n=c};return a("path",e),8589934591<t&&a("size",t),n}function o(e,t,r,n="0",a="000644"){const o=8589934591<t?0:t,s=k.slice(0);s[156]=n.charCodeAt(0);const d=y.encode(e);if(100<d.length){let e=100;for(;0<e&&128==(192&d[e]);)e--;s.set(d.subarray(0,e),0)}else s.set(d,0);a&&y.encodeInto(a.padEnd(7,"\0"),s.subarray(100,108));const c=(e,t,r)=>{const n=Math.floor(e).toString(8).padStart(r-1,"0");n.length>=r||(y.encodeInto(n,s.subarray(t,t+r-1)),s[t+r-1]=0)};c(o,124,12),c(r,136,12);let l=0;for(let o=0;512>o;o++)l+=s[o];const u=l.toString(8).padStart(6,"0");return y.encodeInto(u,s.subarray(148)),s[154]=0,s[155]=32,s}function i(e){const t=b.decode(e.slice(148,156)).replace(/\0/g,"").trim(),r=parseInt(t,8);if(isNaN(r))return!1;let n=0;for(let t=0;512>t;t++)n+=148<=t&&156>t?32:e[t];return n===r}async function s(t={}){function n(e,t,r){return T?P(e,t,r):u.TRUST}async function a(e,t){try{return await e()}catch(r){if(f.onerror&&f.onerror(r),S(`Error: ${t} - ${r.message}`),!w)throw r;return null}}async function o(e,t,a,o){if(E)return!1;if(void 0===F[o])if(T){let t=n(e,void 0,void 0);if(t&&"function"==typeof t.then&&(t=await t),F[o]=t,F[o]===u.ABORT)return E=!0,!1}else F[o]=u.TRUST;if(F[o]===u.SKIP)return!1;if(F[o]===u.TRUST)return!0;if(T&&t){I[o]||(I[o]=new Set);for(let e=1;e<=t.length;e++){const r=t.slice(0,e).join("/");if(I[o].has(r))return!0}let r=n(e,t,null);return(r&&"function"==typeof r.then&&(r=await r),r===u.ABORT)?(E=!0,!1):r!==u.SKIP&&(r===u.TRUST&&I[o].add(t.join("/")),!0)}return!!T||r(o,a,f)}const s=window.CBOR,f={opfs:!0,localStorage:!0,session:!0,cookies:!0,idb:!0,cache:!0,logSpeed:100,graceful:!1,...t},h=f.decoder||new s.Decoder({structuredClone:!0,bundleStrings:!0,copyBuffers:!1,...f.cborOptions}),g=f.cborExtensionName;let y=f.source;if(!y)throw new Error("No source provided. Pass a URL, Blob, or File via the source config property.");const S=f.logger||(()=>{}),k=e(f.logSpeed),w=f.graceful,T="function"==typeof f.onVisit,P=f.onVisit;let E=!1;const F={},I={};let C={category:"",detail:""};const v={};let B=!1;try{async function e(e){for(;!z.has(e)&&!D;){const{value:e,done:t}=await U.read();t?D=!0:z.push(e)}return z.has(e)}async function t(t){for(;0<t&&(0!==z.totalSize||D||(await e(1)),0!==z.totalSize);)await z.consume(t,()=>{}),t=0}async function d(e,t){try{for(let r=t;0<r;){const n=k();if(n){let e=`Importing ${C.category}: ${(A/1e6).toFixed(2)} MB`;e+=1e6<t?` (${C.detail}: ${((t-r)/1e6).toFixed(1)}/${(t/1e6).toFixed(1)} MB)`:` (${C.detail})`,S(e),await n}if(0<z.totalSize){const t=Math.min(r,z.totalSize);await z.consume(t,async t=>{await e.write(t),r-=t.byteLength})}else{let{value:t,done:n}=await U.read();if(n)throw new Error("Unexpected EOF.");t.byteLength<=r?(await e.write(t),r-=t.byteLength):(await e.write(t.subarray(0,r)),z.push(t.subarray(r)),r=0)}}}finally{try{await e.close()}catch(t){}}}function c(e){const t={};for(let r=0;r<e.length;){let n=-1;for(let t=r;t<e.length;t++)if(32===e[t]){n=t;break}if(-1===n)break;const a=b.decode(e.subarray(r,n)),o=parseInt(a,10);if(isNaN(o))break;const i=e.subarray(r,r+o),s=b.decode(i),d=s.indexOf("=");if(-1!==d){const e=s.indexOf(" "),r=s.slice(e+1,d),n=s.slice(d+1,-1);t[r]=n}r+=o}return t}let p;if("string"==typeof y){const e=await fetch(y);if(!e.ok)throw new Error("Fetching of URL failed.");p=e.body}else if(y&&"function"==typeof y.stream)p=y.stream();else throw new Error("Invalid source.");const w=p.getReader(),P=[];let I=0;for(;8>I;){const{value:e,done:t}=await w.read();if(t)break;P.push(e),I+=e.byteLength}w.releaseLock();let A=0;const x=new ReadableStream({async start(t){for(const e of P)t.enqueue(e);const r=p.getReader();try{for(;;){const{value:e,done:n}=await r.read();if(n)break;t.enqueue(e)}t.close()}catch(r){t.error(r)}}}),L=new Uint8Array(8);if(0<I){let e=0;for(const t of P){const r=8-e;if(0>=r)break;const n=Math.min(r,t.byteLength);L.set(t.subarray(0,n),e),e+=n}}const K=b.decode(L.slice(0,6));let _;if("LE_ENC"===K){let e=f.password||prompt("Enter the password:");if(!e)throw new Error("A password is required to decrypt this data.");_=new R(x,e,k).readable().pipeThrough(new DecompressionStream("gzip"))}else _=31===L[0]&&139===L[1]?x.pipeThrough(new DecompressionStream("gzip")):x;_=_.pipeThrough(new TransformStream({transform(e,t){A+=e.byteLength,t.enqueue(e)}}));const U=_.getReader(),z=new O;let D=!1,W=0;const N=await navigator.storage.getDirectory();let j;try{j=await N.getDirectoryHandle(m,{create:!0})}catch(t){}const q=new Set;for(let y=null;!E;){const m=await e(512);if(!m){if(!B)if(0<W&&0===z.totalSize)S("Warning: Stream ended without standard EOF blocks. Import likely successful.");else throw new Error("Archive truncated: Stream ended prematurely.");break}const w=z.read(512);if(0===w[0]&&w.every(e=>0===e)){B=!0;continue}if(!i(w)){if(0<W&&0===z.totalSize&&D)break;throw new Error("Corrupt TAR header: Checksum mismatch.")}let O=b.decode(w.slice(0,100)).replace(/\0/g,"").trim();const R=w[156],P=b.decode(w.slice(124,136)).replace(/\0/g,"").trim(),I=parseInt(P,8)||0,x=(512-I%512)%512;if(120===R){if(!(await e(I)))throw new Error("Unexpected EOF.");const r=z.read(I);await t(x),y=c(r);continue}let L=I;if(y&&(y.path&&(O=y.path),y.size&&(L=parseInt(y.size,10)),y=null),W++,O.startsWith("data/idb/")){C.category="IndexedDB";const e=O.split("/");C.detail=e[2]?decodeURIComponent(e[2]):"data"}else if(O.startsWith("data/cache/")){C.category="Cache";const e=O.split("/");C.detail=e[2]?decodeURIComponent(e[2]):"item"}else O.startsWith("opfs/")?(C.category="OPFS",C.detail=O.replace("opfs/","")):O.startsWith("data/blobs/")?(C.category="Blobs",C.detail="restoring..."):(C.category="Config",C.detail=O);const K=k();if(K&&(C.category&&S(`Importing ${C.category}: ${(A/1e6).toFixed(2)} MB (${C.detail})`),await K),O.startsWith("data/")){if(O.startsWith("data/blobs/")){const e=O.split("/").pop();if(j){let r=!1;await a(async()=>{const t=await j.getFileHandle(e,{create:!0});r=!0,await d(await t.createWritable(),L)},`Blob ${e}`),r||(await t(L))}else await t(L);await t(x);continue}else{if(0===L){await t(x);continue}if(!(await e(L)))throw new Error("Unexpected EOF for metadata.");const i=z.read(L);if("data/ls.json"===O&&!1!==f.localStorage){if(await o(l.LS,null,null,"localStorage")){const e=JSON.parse(b.decode(i)),t=F.localStorage===u.TRUST;for(const a in e){if(E)break;let o=t;if(!o)if(T){let t=n(l.LS,[a],{value:e[a]});if(t&&"function"==typeof t.then&&(t=await t),t===u.ABORT){E=!0;break}o=t!==u.SKIP}else o=r("localStorage",a,f);o&&localStorage.setItem(a,e[a])}}}else if("data/ss.json"===O&&!1!==f.session){if(await o(l.SS,null,null,"session")){const e=JSON.parse(b.decode(i)),t=F.session===u.TRUST;for(const a in e){if(E)break;let o=t;if(!o)if(T){let t=n(l.SS,[a],{value:e[a]});if(t&&"function"==typeof t.then&&(t=await t),t===u.ABORT){E=!0;break}o=t!==u.SKIP}else o=r("session",a,f);o&&sessionStorage.setItem(a,e[a])}}}else if("data/cookies.json"===O&&!1!==f.cookies){if(await o(l.COOKIE,null,null,"cookies")){const e=JSON.parse(b.decode(i)),t=F.cookies===u.TRUST;for(const a in e){if(E)break;let o=t;if(!o)if(T){let t=n(l.COOKIE,[a],{value:e[a]});if(t&&"function"==typeof t.then&&(t=await t),t===u.ABORT){E=!0;break}o=t!==u.SKIP}else o=r("cookies",a,f);o&&(document.cookie=`${a}=${e[a]}; path=/; max-age=31536000`)}}}else if(O.startsWith("data/custom/")&&f.onCustomItem)await f.onCustomItem(O.replace("data/custom/",""),i);else if(O.startsWith("data/idb/")&&s&&!1!==f.idb){const e=O.split("/"),t=decodeURIComponent(e[2]);if(O.endsWith("schema."+g)){if(!(await o(l.IDB,[t],t,"idb")))continue;const n=h.decode(i);q.add(t),v[t]&&(v[t].close(),delete v[t]),await a(async()=>{await new Promise(e=>{const t=indexedDB.deleteDatabase(n.name);t.onsuccess=e,t.onerror=e}),await new Promise((t,r)=>{const a=indexedDB.open(n.name,n.version);a.onupgradeneeded=t=>{const e=t.target.result;n.stores.forEach(t=>{if(!e.objectStoreNames.contains(t.name)){const r=e.createObjectStore(t.name,{keyPath:t.keyPath,autoIncrement:t.autoIncrement});t.indexes.forEach(e=>r.createIndex(e.name,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry}))}})},a.onsuccess=r=>{r.target.result.close(),t()},a.onerror=r})},`IDB schema ${t}`)}else{const r=decodeURIComponent(e[3]);if(!q.has(t))continue;if(!(await o(l.IDB,[t,r],`${t}/${r}`,"idb")))continue;const n=h.decode(i),[s,d]=await LittleExport.restoreFromCBOR(n,j);if(!v[t]){const e=await a(async()=>await new Promise((e,r)=>{const n=indexedDB.open(t),a=setTimeout(()=>r(new Error(`Database ${t} timed out.`)),5e3);n.onblocked=()=>{clearTimeout(a),r(new Error(`Database ${t} blocked.`))},n.onsuccess=()=>{clearTimeout(a),e(n.result)},n.onerror=()=>{clearTimeout(a),r(n.error)}}),`Opening IDB ${t}`);if(!e)continue;v[t]=e}await a(async()=>{const e=v[t].transaction(r,"readwrite"),n=e.objectStore(r);for(let e=0;e<s.length;e++)n.put(d[e],n.keyPath?void 0:s[e]);await new Promise((t,r)=>{e.oncomplete=t,e.onerror=()=>r(e.error),e.onabort=()=>r(new Error("Transaction aborted."))})},`IDB ${t}/${r}`)}}else if(O.startsWith("data/cache/")&&s&&!1!==f.cache){const e=O.split("/"),t=decodeURIComponent(e[2]);(await o(l.CACHE,[t],t,"cache"))&&(await a(async()=>{const e=h.decode(i),r=await caches.open(t),n=new Response(e.data,{status:e.meta.status,headers:e.meta.headers});await r.put(e.meta.url,n)},`Cache ${t}`))}}}else if(!1!==f.opfs){const e=O.startsWith("opfs/")?O.slice(5):O,r=e.endsWith("/")||53===w[156],n=e.replace(/\/$/,""),i=n.split("/").filter(e=>e.length);if(0<i.length){const e=[...i];(await o(l.OPFS,e,n,"opfs"))?await a(async()=>{let e=N;if(r)for(const t of i)e=await e.getDirectoryHandle(t,{create:!0});else{const t=i[i.length-1],r=i.slice(0,-1);for(const t of r)e=await e.getDirectoryHandle(t,{create:!0});const n=await e.getFileHandle(t,{create:!0});if(0<L)await d(await n.createWritable(),L);else{const e=await n.createWritable();await e.close()}}},`OPFS ${n}`):await t(L)}else await t(L)}else await t(L);await t(x)}if(j)try{await N.removeEntry(m,{recursive:!0})}catch(t){}Object.values(v).forEach(e=>e.close()),E||S("Import complete!")}catch(t){if(Object.values(v).forEach(e=>{try{e.close()}catch(t){}}),S(`Error: ${t.message}`),f.onerror&&f.onerror(t),!w)throw t}finally{try{await rootOpfs.removeEntry(m,{recursive:!0})}catch(t){}}}function d(e,t){const{readable:r,writable:n}=new TransformStream,a=new w(n,t);return(async()=>{try{if(window.FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle){async function t(e,r){for await(const[n,o]of e.entries()){if("directory"===o.kind&&"PaxHeaders"===n)continue;const e=r?`${r}/${n}`:n;if("file"===o.kind){const t=await o.getFile();await a.writeStream(e,t.size,t.stream())}else"directory"===o.kind&&(await a.writeDir(e),await t(o,e))}}await t(e,"")}else if(e instanceof FileList||Array.isArray(e)&&e[0]instanceof File){const t=Array.from(e),r=t[0].webkitRelativePath,n=r?r.split("/")[0]+"/":"";for(const e of t){let t=e.webkitRelativePath;t.startsWith(n)&&(t=t.slice(n.length)),t||(t=e.name),await a.writeStream(t,e.size,e.stream())}}await a.close()}catch(t){try{await n.abort(t)}catch(t){}}})(),r}const l={OPFS:1,IDB:2,LS:4,SS:8,COOKIE:16,CACHE:32},u={SKIP:0,PROCESS:1,TRUST:2,ABORT:3};let f=0;const h=4194304,g=65536,y=new TextEncoder,b=new TextDecoder("utf-8",{fatal:!1}),m=".rfs_temp_blobs",S={USTAR_MAGIC:new Uint8Array([117,115,116,97,114,0]),USTAR_VER:new Uint8Array([48,48]),EMPTY_SPACE:new Uint8Array(8).fill(32)},k=new Uint8Array(512);(function(){const e=(e,t)=>y.encodeInto(e,k.subarray(t));e("000644 \0",100),e("000000 \0",108),e("000000 \0",116),k.set(S.EMPTY_SPACE,148),k[156]=48,k.set(S.USTAR_MAGIC,257),k.set(S.USTAR_VER,263)})();class w{constructor(e,t){this.writer=e.getWriter(),this.yielder=t,this.pos=0,this.bytesWritten=0,this.time=Math.floor(Date.now()/1e3),this.buffer=new Uint8Array(g),this.bufferOffset=0,this.headerBuffer=new Uint8Array(512)}async writeEntry(e,t){const r="string"==typeof t?y.encode(t):t,n=r.byteLength;this.onFileProgress&&this.onFileProgress(0,n),await this.smartWrite(e,n,async()=>{await this.write(r)}),this.onFileProgress&&this.onFileProgress(n,n)}async checkAndWritePax(e,t){const r=100<y.encode(e).length;if(r||8589934591<t){const r=a(e,t),n="PaxHeaders/"+(50<e.length?e.slice(0,50):e),i=o(n,r.length,this.time,"x");return await this.write(i),await this.write(r),await this.pad(),!0}return!1}async writeStream(e,t,r){let n=0;await this.flush(),await this.smartWrite(e,t,async()=>{const e=r.getReader();try{for(;;){const{done:r,value:a}=await e.read();if(r)break;if(a){const e=t-n;if(0>=e)continue;const r=a.byteLength>e?a.subarray(0,e):a;await this.write(r),n+=r.byteLength,this.onFileProgress&&this.onFileProgress(n,t)}const o=this.yielder();o&&(await o)}if(n<t){const e=t-n,r=new Uint8Array(e);await this.write(r)}}finally{e.releaseLock()}})}async smartWrite(e,t,r){const n=y.encode(e),i=100<n.length||8589934591<t;if(i){const r=a(e,t),n="PaxHeaders/"+(50<e.length?e.slice(0,50):e);await this.write(o(n,r.length,this.time,"x")),await this.write(r),await this.pad()}await this.write(o(e,t,this.time,0===t&&e.endsWith("/")?"5":"0")),this.bytesWritten=0,r&&(await r()),await this.pad(),this.bytesWritten=0}async writeDir(e){await this.checkAndWritePax(e,0);const t=o(e,0,this.time,"5","000755");await this.write(t)}async write(e){const t=e.byteLength;t>=g?(await this.flush(),await this.writer.write(e)):this.bufferOffset+t>g?(await this.flush(),this.buffer.set(e,0),this.bufferOffset=t):(this.buffer.set(e,this.bufferOffset),this.bufferOffset+=t),this.pos+=t,this.bytesWritten+=t}async pad(){const e=(512-this.pos%512)%512;0<e&&(await this.write(new Uint8Array(e)))}async flush(){0<this.bufferOffset&&(await this.writer.write(this.buffer.subarray(0,this.bufferOffset)),this.bufferOffset=0)}async close(){await this.write(new Uint8Array(1024)),await this.flush(),await this.writer.close()}}class T{constructor(e,r){this.salt=r,this.keyPromise=t(e,r),this.chunks=[],this.currentSize=0}async start(e){e.enqueue(y.encode("LE_ENC")),e.enqueue(this.salt),await this.encryptAndPush(new Uint8Array(0),e,await this.keyPromise)}async transform(e,t){if(this.chunks.push(e),this.currentSize+=e.byteLength,this.currentSize>=h){const e=new Uint8Array(this.currentSize);let r=0;for(const t of this.chunks)e.set(t,r),r+=t.byteLength;const n=await this.keyPromise;let a=0;for(;a+h<=e.length;)await this.encryptAndPush(e.subarray(a,a+h),t,n),a+=h;const o=e.subarray(a);this.chunks=0<o.length?[o]:[],this.currentSize=o.length}}async flush(e){if(0<this.currentSize){const t=new Uint8Array(this.currentSize);let r=0;for(const e of this.chunks)t.set(e,r),r+=e.byteLength;await this.encryptAndPush(t,e,await this.keyPromise)}}async encryptAndPush(e,t,r){const n=crypto.getRandomValues(new Uint8Array(12)),a=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},r,e),o=new DataView(new ArrayBuffer(4));o.setUint32(0,a.byteLength,!0),t.enqueue(n),t.enqueue(new Uint8Array(o.buffer)),t.enqueue(new Uint8Array(a))}}class O{constructor(){this.chunks=[],this.totalSize=0,this.offset=0}push(e){e&&0!==e.byteLength&&(this.chunks.push(e),this.totalSize+=e.byteLength)}has(e){return this.totalSize>=e}_internalConsume(e,t){for(let r=0;r<e&&0<this.chunks.length;){const n=this.chunks[0],a=n.byteLength-this.offset,o=e-r,i=Math.min(a,o);t(n.subarray(this.offset,this.offset+i)),this.offset+=i,this.offset>=n.byteLength&&(this.chunks.shift(),this.offset=0),this.totalSize-=i,r+=i}}read(e){if(0===e)return new Uint8Array(0);if(this.totalSize<e)throw new Error("Insufficient chunk data.");if(0<this.chunks.length&&this.chunks[0].byteLength-this.offset>=e){const t=this.chunks[0].subarray(this.offset,this.offset+e);return this.offset+=e,this.offset>=this.chunks[0].byteLength&&(this.chunks.shift(),this.offset=0),this.totalSize-=e,t}const t=new Uint8Array(e);let r=0;return this._internalConsume(e,e=>{t.set(e,r),r+=e.byteLength}),t}async consume(e,t){for(let r=e;0<r&&0<this.chunks.length;){const e=this.chunks[0],n=e.byteLength-this.offset,a=Math.min(n,r);await t(e.subarray(this.offset,this.offset+a)),this.offset+=a,this.offset>=e.byteLength&&(this.chunks.shift(),this.offset=0),this.totalSize-=a,r-=a}}}class R{constructor(e,t,r){this.stream=e,this.password=t,this.yielder=r,this.buffer=new O}readable(){async function e(e){for(;!r.buffer.has(e);){const{value:e,done:t}=await n.read();if(t)return!1;r.buffer.push(e)}return!0}const r=this;let n;return new ReadableStream({async start(a){n=r.stream.getReader();try{if(!(await e(22)))throw new Error("Not an encrypted archive.");const o=b.decode(r.buffer.read(6));if("LE_ENC"!==o)throw new Error("Not an encrypted archive.");const i=r.buffer.read(16),s=await t(r.password,i);if(!(await e(16)))throw new Error("Corrupt header.");const d=r.buffer.read(12),c=r.buffer.read(4),l=new DataView(c.buffer,c.byteOffset,c.byteLength).getUint32(0,!0);if(16!==l||!(await e(l)))throw new Error("Corrupt header.");const u=r.buffer.read(l);try{await crypto.subtle.decrypt({name:"AES-GCM",iv:d},s,u)}catch(t){throw new Error("Incorrect password or corrupt file.")}for(;;){const e=r.yielder();if(e&&(await e),!r.buffer.has(16)){const{value:e,done:t}=await n.read();if(t){if(0===r.buffer.totalSize)break;throw new Error("Truncated encrypted stream.")}r.buffer.push(e);continue}const t=r.buffer.read(12),o=r.buffer.read(4),i=new DataView(o.buffer,o.byteOffset,o.byteLength).getUint32(0,!0);for(;!r.buffer.has(i);){const{value:e,done:t}=await n.read();if(t)throw new Error("Unexpected EOF in ciphertext.");r.buffer.push(e);const a=r.yielder();a&&(await a)}const d=r.buffer.read(i),c=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},s,d),l=r.yielder(!0);l&&(await l),a.enqueue(new Uint8Array(c))}a.close()}catch(t){a.error(t)}finally{n.releaseLock()}}})}}window.LittleExport={importData:s,exportData:async function(t={}){function n(e,t,r){return b?m(e,t,r):u.TRUST}async function a(e,t){try{return await e()}catch(r){if(y)return s.onerror&&s.onerror(r),h(`Error: ${t} - ${r.message}`),null;throw r}}f=0;const o=window.CBOR,s={fileName:"archive",opfs:!0,localStorage:!0,session:!0,cookies:!0,idb:!0,cache:!0,logSpeed:100,customItems:[],include:{},exclude:{},graceful:!1,download:!0,cborExtensionName:"cbor",...t},d=s.encoder||new o.Encoder({structuredClone:!0,copyBuffers:!1,bundleStrings:!0,...s.cborOptions}),c=s.cborExtensionName,h=s.logger||(()=>{}),g=e(s.logSpeed),y=s.graceful,b="function"==typeof s.onVisit,m=s.onVisit;let S=!1;const O={category:"",detail:""};let R,P=[];if(window.showSaveFilePicker&&!1!==s.download)try{const e=s.password?`${s.fileName}.enc`:`${s.fileName}.tar.gz`,t=await window.showSaveFilePicker({suggestedName:e});R=await t.createWritable()}catch(t){if("AbortError"===t.name)return void h("Export cancelled.");console.warn("FileSystem picker failed, falling back.")}R||(R=new WritableStream({write(e){P.push(e)},close(){}}));let E=0,F=0;const I=new TransformStream({async transform(e,t){E+=e.byteLength;const r=Date.now();if(r-F>s.logSpeed){if(F=r,O.category)if("Finishing"===O.category)h("Finishing...");else{let e=`Exporting ${O.category}: ${(E/1e6).toFixed(2)} MB`;e+=1e6<B.total?` (${O.detail}: ${(B.written/1e6).toFixed(1)}/${(B.total/1e6).toFixed(1)} MB)`:` (${O.detail})`,h(e)}const e=g();e&&(await e)}t.enqueue(e)}}),C=new CompressionStream("gzip");let v=C.readable;if(s.password){O.category="Setup",O.detail="Encrypting...";const e=crypto.getRandomValues(new Uint8Array(16));v=v.pipeThrough(new TransformStream(new T(s.password,e)))}let B={written:0,total:0};const A=v.pipeThrough(I).pipeTo(R),x=new w(C.writable,g);x.onFileProgress=(e,t)=>{B.written=e,B.total=t};try{for(const e of s.customItems){if(S)break;O.category="custom",O.detail=e.path;const t=`data/custom/${e.path}`;e.data instanceof Blob?await x.writeStream(t,e.data.size,e.data.stream()):await x.writeEntry(t,"string"==typeof e.data?e.data:JSON.stringify(e.data))}if(!S&&s.opfs&&navigator.storage){let e=n(l.OPFS,void 0,void 0);if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT&&(S=!0),!S&&e!==u.SKIP){async function t(e,o,i){try{for await(const d of e.values()){if(S)return;B.written=0,B.total=0;const e=[...o,d.name],c=e.join("/");let f=i;if(O.detail=c,!i)if(b){let t=n(l.OPFS,e,{kind:d.kind,handle:d});if(t&&"function"==typeof t.then&&(t=await t),f=t,f===u.ABORT)return void(S=!0);if(f===u.SKIP)continue}else{if(!r("opfs",c,s))continue;f=u.TRUST}const h=f===u.TRUST;"file"===d.kind?await a(async()=>{const e=await d.getFile();await x.writeStream(`opfs/${c}`,e.size,e.stream())},`OPFS file ${c}`):(await x.writeDir(`opfs/${c}`),await t(d,e,!!h&&u.TRUST));const y=g();y&&(await y)}}catch(t){if(h(`Error: accessing OPFS folder /${o.join("/")} failed (${t.message})`),s.onerror&&s.onerror(t),!y)throw t}}O.category="OPFS";const o=await navigator.storage.getDirectory(),i=e===u.TRUST;await t(o,[],!!i&&u.TRUST)}}if(!S&&s.idb&&window.indexedDB&&o){let e=n(l.IDB,void 0,void 0);if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT&&(S=!0),!S&&e!==u.SKIP){O.category="IndexedDB";const t=e===u.TRUST,o=await window.indexedDB.databases();for(const{name:e,version:i}of o){if(S)break;B.written=0,B.total=0,O.detail=e;const o=encodeURIComponent(e),f=await a(async()=>await new Promise((t,r)=>{const n=indexedDB.open(e),a=setTimeout(()=>r(new Error(`Database ${e} timed out.`)),5e3);n.onblocked=()=>{clearTimeout(a),r(new Error(`Database ${e} blocked.`))},n.onsuccess=()=>{clearTimeout(a),t(n.result)},n.onerror=()=>{clearTimeout(a),r(n.error)}}),`Opening IDB ${e}`);if(!f)continue;let h=t?u.TRUST:u.PROCESS;if(!t)if(b){let t=n(l.IDB,[e],{database:f});if(t&&"function"==typeof t.then&&(t=await t),h=t,h===u.ABORT){S=!0,f.close();break}if(h===u.SKIP){f.close();continue}}else if(!r("idb",e,s)){f.close();continue}const y=h===u.TRUST;try{const t=Array.from(f.objectStoreNames);if(0===t.length){await x.writeEntry(`data/idb/${o}/schema.${c}`,d.encode({name:e,version:i,stores:[]}));continue}const h=[],p=f.transaction(t,"readonly");for(const e of t){const t=p.objectStore(e);h.push({name:e,keyPath:t.keyPath,autoIncrement:t.autoIncrement,indexes:Array.from(t.indexNames).map(e=>{const r=t.index(e);return{name:r.name,keyPath:r.keyPath,unique:r.unique,multiEntry:r.multiEntry}})})}await x.writeEntry(`data/idb/${o}/schema.${c}`,d.encode({name:e,version:i,stores:h}));for(const i of t){if(S)break;let t=y?u.TRUST:u.PROCESS;if(!y)if(b){let r=n(l.IDB,[e,i],{database:f});if(r&&"function"==typeof r.then&&(r=await r),t=r,t===u.ABORT){S=!0;break}if(t===u.SKIP)continue}else if(!r("idb",`${e}/${i}`,s))continue;O.detail=`${e}/${i}`;let h=null,m=0,k=!0;for(;k&&!S;){const t=await a(async()=>{return await new Promise((t,r)=>{const n=f.transaction(i,"readonly"),a=n.objectStore(i),o=null===h?null:IDBKeyRange.lowerBound(h,!0),s=a.openCursor(o),d=[],c=[];s.onsuccess=r=>{const e=r.target.result;e&&d.length<25?(d.push(e.key),c.push(e.value),h=e.key,e.continue()):t({keys:d,values:c,done:!e})},s.onerror=()=>r(s.error)})},`Reading IDB ${e}/${i}`);if(!t)break;if(k=!t.done,0<t.keys.length){const e=[];for(let r=0;r<t.values.length;r++){const n=[],a=LittleExport.prepForCBOR(t.values[r],n);e.push(a);for(const e of n)await x.writeStream(`data/blobs/${e.uuid}`,e.blob.size,e.blob.stream())}await x.writeEntry(`data/idb/${o}/${encodeURIComponent(i)}/${m++}.${c}`,d.encode([t.keys,e]));const r=g();r&&(await r)}}}}finally{f.close()}}}}if(!S&&s.localStorage){let e=n(l.LS,void 0,void 0);if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT&&(S=!0),!S&&e!==u.SKIP){O.category="Storage";const t={},a=e===u.TRUST;for(let e=0;e<localStorage.length&&!S;e++){const o=localStorage.key(e);O.detail=`localStorage: ${o}`;let i=a;if(!i)if(b){let e=n(l.LS,[o],{value:localStorage.getItem(o)});if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT){S=!0;break}i=e!==u.SKIP}else i=r("localStorage",o,s);i&&(t[o]=localStorage.getItem(o))}!S&&0<Object.keys(t).length&&(await x.writeEntry("data/ls.json",JSON.stringify(t)))}}if(!S&&s.session){let e=n(l.SS,void 0,void 0);if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT&&(S=!0),!S&&e!==u.SKIP){O.category="Storage";const t={},a=e===u.TRUST;for(let e=0;e<sessionStorage.length&&!S;e++){const o=sessionStorage.key(e);O.detail=`sessionStorage: ${o}`;let i=a;if(!i)if(b){let e=n(l.SS,[o],{value:sessionStorage.getItem(o)});if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT){S=!0;break}i=e!==u.SKIP}else i=r("session",o,s);i&&(t[o]=sessionStorage.getItem(o))}!S&&0<Object.keys(t).length&&(await x.writeEntry("data/ss.json",JSON.stringify(t)))}}if(!S&&s.cookies){let e=n(l.COOKIE,void 0,void 0);if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT&&(S=!0),!S&&e!==u.SKIP){O.category="Storage";const t={},a=e===u.TRUST,o=document.cookie.split(";").map(e=>e.trim()).filter(Boolean);for(const e of o){if(S)break;const o=e.indexOf("="),i=-1<o?e.slice(0,o).trim():e.trim(),d=-1<o?e.slice(o+1).trim():"";if(!i)continue;O.detail=`Cookie: ${i}`;let c=a;if(!c)if(b){let e=n(l.COOKIE,[i],{value:d});if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT){S=!0;break}c=e!==u.SKIP}else c=r("cookies",i,s);c&&(t[i]=d)}!S&&0<Object.keys(t).length&&(await x.writeEntry("data/cookies.json",JSON.stringify(t)))}}if(!S&&s.cache&&window.caches&&o){let e=n(l.CACHE,void 0,void 0);if(e&&"function"==typeof e.then&&(e=await e),e===u.ABORT&&(S=!0),!S&&e!==u.SKIP){O.category="Cache";const t=await caches.keys(),o=e===u.TRUST;for(const e of t){if(S)break;B.written=0,B.total=0;let t=o;if(!t)if(b){let r=n(l.CACHE,[e],null);if(r&&"function"==typeof r.then&&(r=await r),r===u.ABORT){S=!0;break}t=r!==u.SKIP}else t=r("cache",e,s);if(!t)continue;O.detail=e;const i=g();i&&(await i),await a(async()=>{const t=await caches.open(e);for(const r of await t.keys()){const n=await t.match(r);if(!n)continue;const a=await n.blob(),o=btoa(r.url).slice(0,50).replace(/\//g,"_"),i=[],s=LittleExport.prepForCBOR(a,i);for(const e of i)await x.writeStream(`data/blobs/${e.uuid}`,e.blob.size,e.blob.stream());await x.writeEntry(`data/cache/${encodeURIComponent(e)}/${o}.${c}`,d.encode({meta:{url:r.url,status:n.status,headers:Object.fromEntries(n.headers),type:a.type},data:s}))}},`Cache ${e}`)}}}O.category="Finishing",await x.close(),await A;let e=null;if(window.showSaveFilePicker||(e=new Blob(P,{type:"application/octet-stream"})),!1!==s.download){if(e){const t=URL.createObjectURL(e),r=document.createElement("a");r.href=t;let n=s.fileName;r.download=n.includes(".")?n:s.password?`${n}.enc`:`${n}.tar.gz`,r.click(),setTimeout(()=>URL.revokeObjectURL(t),1e3)}return h("Export complete!"),null}return h("Export complete!"),e}catch(t){try{await R.abort(t).catch(()=>{})}catch(t){}if(h(`Error: ${t.message}`),s.onerror&&s.onerror(t),!y)throw t}},deriveKey:t,prepForCBOR:n,restoreFromCBOR:async function(e,t){if(!e||"object"!=typeof e)return e;if(e.__le_blob_ref){if(!t)return null;try{const r=await t.getFileHandle(e.__le_blob_ref),n=await r.getFile();return n.slice(0,n.size,e.type)}catch(t){return null}}if(e.__le_blob)return new Blob([e.data],{type:e.type});if(e.__le_circular)return null;if("sparse_array"===e.__le_type){const r=Array(e.length);for(const n in e.data)r[n]=await LittleExport.restoreFromCBOR(e.data[n],t);return r}if(Array.isArray(e)){const r=Array(e.length);for(let n=0;n<e.length;n++)r[n]=await LittleExport.restoreFromCBOR(e[n],t);return r}if(e.constructor===Object){const r={};for(const n in e)r[n]=await LittleExport.restoreFromCBOR(e[n],t);return r}return e},importFromFolder:async function(t={}){const r={...t},n=e(r.logSpeed),a=e=>s({...r,source:{stream:()=>e}});if(window.showDirectoryPicker&&!0!==r.legacy)try{const e=await window.showDirectoryPicker(),t=d(e,n);return await a(t)}catch(t){if("AbortError"===t.name)return void logger("User cancelled the directory picker.");logger("Directory Picker failed, falling back to legacy input."),console.warn("Directory Picker failed, falling back to legacy input.",t)}return new Promise((e,t)=>{const r=document.createElement("input");r.type="file",r.webkitdirectory=!0,r.multiple=!0,r.style.display="none",document.body.appendChild(r),r.onchange=async()=>{if(!r.files||0===r.files.length)return void e();try{const t=d(r.files,n);await a(t),e()}catch(r){t(r)}finally{document.body.removeChild(r)}},r.oncancel=()=>{document.body.removeChild(r),e()},r.click()})},folderToTarStream:d,clearData:async function(e={}){if(0===Object.keys(e).length&&(e={opfs:!0,idb:!0,localStorage:!0,session:!0,cookies:!0,cache:!0}),e.opfs&&navigator.storage)try{const e=await navigator.storage.getDirectory();for await(const t of e.keys())await e.removeEntry(t,{recursive:!0})}catch(t){console.warn("Failed to clear OPFS:",t)}if(e.localStorage)try{localStorage.clear()}catch(t){console.warn("Failed to clear localStorage:",t)}if(e.session)try{sessionStorage.clear()}catch(t){console.warn("Failed to clear sessionStorage:",t)}if(e.cookies)try{const e=document.cookie.split(";");for(let t=0;t<e.length;t++){const r=e[t],n=r.indexOf("="),a=-1<n?r.trim().substr(0,n):r.trim();document.cookie=`${a}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`,document.cookie=`${a}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; domain=${window.location.hostname}; path=/`;const o=window.location.hostname.split(".");if(2<o.length){const e=o.slice(-2).join(".");document.cookie=`${a}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; domain=.${e}; path=/`}}}catch(t){console.warn("Failed to clear cookies:",t)}if(e.cache&&window.caches)try{const e=await caches.keys();for(const t of e)await caches.delete(t)}catch(t){console.warn("Failed to clear cache:",t)}if(e.idb&&window.indexedDB)try{const e=await window.indexedDB.databases();for(const{name:t}of e)indexedDB.deleteDatabase(t)}catch(t){console.warn("Failed to clear IndexedDB:",t)}},TYPE:l,DECISION:u}})();
const SW_URL="./sw.min.js",RFS_PREFIX="rfs",SYSTEM_FILE="rfs_system.json",CHUNK_SIZE=4194304,CONCURRENCY=4,YIELD_TIME=50;let folderName,dirHandle,observer,isListingFolders=!1,currentlyBusy=!1,changes=[],showingSync=!1,_registryCache=null,_opfsRoot=null;async function getOpfsRoot(){return _opfsRoot||(_opfsRoot=await navigator.storage.getDirectory()),_opfsRoot}function setUiBusy(a){currentlyBusy!==a&&(currentlyBusy=a,Array.from(document.getElementsByTagName("button")).forEach(a=>a.disabled=currentlyBusy))}function createLogger(a,b){let c=null,d=0;return function(e,f=!1){const g=Date.now();return e!==c&&null!==e&&(c=e,(f||g-d>YIELD_TIME)&&(a.textContent=e,d=g)),b(f)}}const checkYield=function(){let a=0;const b=[],c=new MessageChannel;c.port1.onmessage=()=>{const a=b.shift();a&&a()};const d=()=>new Promise(a=>{b.push(a),c.port2.postMessage(null)});return function(b=!1){return b||Date.now()-a>YIELD_TIME?(a=Date.now(),(async()=>{"scheduler"in window&&"yield"in scheduler?await scheduler.yield():await d()})()):null}}(),logProgress=createLogger(document.getElementById("progress"),checkYield);window.addEventListener("beforeunload",function(a){if(currentlyBusy)return a.preventDefault(),"Changes you made may not be saved."}),navigator.storage.persist().then(a=>console.log(a?"Storage persisted.":"Storage not persisted."));async function waitForController(){if(navigator.serviceWorker.controller)return navigator.serviceWorker.controller;await navigator.serviceWorker.register(SW_URL);const a=await navigator.serviceWorker.ready;return navigator.serviceWorker.controller||a.active}async function getRegistry(){return _registryCache?_registryCache:await navigator.locks.request("rfs_registry_lock",{mode:"shared"},async()=>{if(_registryCache)return _registryCache;try{const a=await getOpfsRoot(),b=await a.getFileHandle(SYSTEM_FILE),c=await b.getFile(),d=await c.text();_registryCache=d?JSON.parse(d):{}}catch(a){_registryCache={}}return _registryCache})}async function saveRegistry(a){_registryCache=a,await navigator.locks.request("rfs_registry_lock",{mode:"exclusive"},async()=>{const b=await getOpfsRoot(),c=await b.getFileHandle(SYSTEM_FILE,{create:!0}),d=await c.createWritable();await d.write(JSON.stringify(a)),await d.close()})}async function updateRegistryEntry(a,b){return navigator.locks.request("rfs_registry_lock",{mode:"exclusive"},async()=>{const c=await getOpfsRoot();let d={};try{const a=await c.getFileHandle(SYSTEM_FILE),b=await a.getFile();d=JSON.parse(await b.text())}catch(a){d={}}null===b?delete d[a]:d[a]={...(d[a]||{}),...b,lastModified:Date.now()},_registryCache=d;const e=await c.getFileHandle(SYSTEM_FILE,{create:!0}),f=await e.createWritable();await f.write(JSON.stringify(d)),await f.close(),navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"INVALIDATE_CACHE",folderName:a})})}async function analyzeAndImportFolder(a,b=null){async function c(c){try{if(b){const a=c.join("/");return b.some(b=>b.webkitRelativePath.endsWith(`/${a}`)||b.webkitRelativePath===a)}if("directory"===a.kind){let b=a;for(let a=0;a<c.length-1;a++)b=await b.getDirectoryHandle(c[a]);return await b.getFileHandle(c[c.length-1]),!0}if(a.isDirectory)return new Promise(b=>{a.getFile(c.join("/"),{create:!1},()=>b(!0),()=>b(!1))})}catch(a){return!1}}let d=!1,e=!1;if((await c(["manifest.enc"]))&&(d=!0),d||((await c(["data","custom",SYSTEM_FILE]))?e=!0:(await c(["custom",SYSTEM_FILE]))&&(e=!0)),d){const c=prompt(`"${a.name||"Folder"}" appears to be an encrypted folder. Enter a name to mount it as:`,a.name);return c?(setUiBusy(!0),void(b?(alert("Encrypted folder import via file input not supported yet. Use Drag & Drop or Directory Picker."),setUiBusy(!1)):"directory"===a.kind?await processFolderSelection(c,a):(alert("Please use the 'Upload Folder' button for encrypted folders."),setUiBusy(!1)))):void 0}if(e&&confirm("Found system configuration folder. (This may modify multiple folders or local data.)")){let c;return c=b?LittleExport.folderToTarStream(b,checkYield):LittleExport.folderToTarStream(a,checkYield),void(await startImport({stream:()=>c}))}const f=document.getElementById("folderName").value.trim()||prompt("Enter a name for the folder:",a.name||"");f&&(setUiBusy(!0),b?await processFilesAndStore(f,b):"directory"===a.kind?await processFolderSelection(f,a):(alert("Please use drag-and-drop for this folder."),setUiBusy(!1)))}async function uploadFolder(){try{if(window.showDirectoryPicker){setUiBusy(!0);const a=await window.showDirectoryPicker({mode:"read"});await analyzeAndImportFolder(a)}else document.getElementById("folderUploadFallbackInput").click()}catch(a){"AbortError"!==a.name&&(console.error(a),alert("Error accessing folder: "+a.message))}finally{setUiBusy(!1)}}async function uploadFolderFallback(a){const b=a.target;return b.files.length?void(await analyzeAndImportFolder({},Array.from(b.files)),b.value=""):void setUiBusy(!1)}async function processFolderSelection(a,b){dirHandle=b,folderName=a;try{const c=await b.getFileHandle("manifest.enc"),d=await getOpfsRoot(),e=await d.getDirectoryHandle(RFS_PREFIX,{create:!0});try{await e.removeEntry(a,{recursive:!0})}catch(a){return void("NotFoundError"!==a.name&&alert("RuntimeFS cannot currently remove this folder; try closing other open RuntimeFS tabs."))}await decryptAndLoadFolderToOpfs(b,c,await e.getDirectoryHandle(a,{create:!0})),await updateRegistryEntry(a,{encryptionType:null})}catch(c){await processFolderStreaming(a,b)}if(observer){try{observer.disconnect()}catch(a){}observer=null}if("FileSystemObserver"in window)try{observer=new FileSystemObserver(a=>changes.push(...a)),observer.observe(dirHandle,{recursive:!0}),showingSync||(Array.from(document.body.getElementsByClassName("supportCheck")).forEach(a=>a.style.display="revert"),showingSync=!0)}catch(a){console.warn("Observer failed:",a)}changes.length=0,document.getElementById("folderName").value="",document.getElementById("openFolderName").value=a,await updateRegistryEntry(a,{encryptionType:null}),await logProgress("",!0),setUiBusy(!1),await listFolders()}async function decryptAndLoadFolderToOpfs(a,b,c){const d=prompt("Enter the password to decrypt this folder:");if(!d)throw new Error("Password required.");const e=await b.getFile(),f=await e.arrayBuffer(),g=f.slice(0,16),h=f.slice(16,28),i=f.slice(28),j=await deriveKeyFromPassword(d,g);let k;try{const a=await crypto.subtle.decrypt({name:"AES-GCM",iv:h},j,i);k=JSON.parse(new TextDecoder().decode(a))}catch(a){throw new Error("Decryption failed. Wrong password?")}const l=await a.getDirectoryHandle("content"),m=Object.entries(k),n=m.length;let o=0;const p=new Map;p.set(".",c);const q=async()=>{for(;0<m.length;){const a=m.shift();if(!a)break;const[b,d]=a,e=logProgress(`Decrypting (${o}/${n}): ${b}`);e&&(await e);const f=b.split("/"),g=f.pop();let h=c;if(0<f.length){let a=".";h=await p.get(".");for(const b of f){const c=a;if(a+="/"+b,!p.has(a)){const d=p.get(c),e=d.then(a=>a.getDirectoryHandle(b,{create:!0}));p.set(a,e)}h=await p.get(a)}}let i;try{const a=await l.getFileHandle(d.id);i=await a.getFile()}catch(a){console.warn(`Missing: ${b}`),o++;continue}const k=await h.getFileHandle(g,{create:!0}),q=await k.createWritable();if(0<d.size){const a=i.stream().getReader(),b=Math.ceil(d.size/CHUNK_SIZE);let c=new Uint8Array(0),e=0;try{for(;e<b;){const f=checkYield();f&&(await f);const g=e===b-1,h=g?d.size%CHUNK_SIZE||CHUNK_SIZE:CHUNK_SIZE,i=h+28;for(;c.length<i;){const{done:b,value:d}=await a.read();if(b)break;const e=new Uint8Array(c.length+d.length);e.set(c),e.set(d,c.length),c=e}if(c.length<i)break;const k=c.subarray(0,i);c=c.subarray(i);const l=k.subarray(0,12),m=k.subarray(12),n=await crypto.subtle.decrypt({name:"AES-GCM",iv:l},j,m);await q.write(new Uint8Array(n)),e++}}finally{a.releaseLock()}}try{await q.close()}catch(a){if("TypeError"!==a.name)throw a}o++}};await Promise.all(Array(CONCURRENCY).fill(null).map(q)),await logProgress("",!0)}async function processFilesAndStore(a,b){const c=await getOpfsRoot(),d=await c.getDirectoryHandle(RFS_PREFIX,{create:!0});try{await d.removeEntry(a,{recursive:!0})}catch(a){}const e=await d.getDirectoryHandle(a,{create:!0});let f=0;for(const c of b)f+=c.size;let g=0;const h=Array.from(b),i=()=>{const a=(g/1e6).toFixed(2),b=(f/1e6).toFixed(2),c=0<f?(100*(g/f)).toFixed(2):"100.00";return logProgress(`Uploading: ${c}% (${a} / ${b} MB)`)},j=Array(CONCURRENCY).fill(null).map(async()=>{for(const a=new Map;0<h.length;){const b=h.shift();if(!b)break;let c=b.webkitRelativePath||b.name;const d=c.split("/");1<d.length&&d.shift(),c=d.join("/");let f=0;await writeStreamToOpfs(e,c,b,{dirCache:a,onProgress:async a=>{if(g+=a,f+=a,1048576<f){let a=i();a&&(await a),f=0}}});const j=checkYield();j&&(await j)}});await Promise.all(j),document.getElementById("folderName").value="",document.getElementById("openFolderName").value=a,await updateRegistryEntry(a,{encryptionType:null}),await logProgress("",!0),await listFolders()}async function processFolderStreaming(a,b){const c=await getOpfsRoot(),d=await c.getDirectoryHandle(RFS_PREFIX,{create:!0});try{await d.removeEntry(a,{recursive:!0})}catch(a){if("NotFoundError"!==a.name)return void alert("RuntimeFS cannot currently remove this folder; try closing other open RuntimeFS tabs.")}const e=await d.getDirectoryHandle(a,{create:!0}),f=[];let g=!1,h=0,i=0;const j=()=>{const a=(i/1e6).toFixed(2),b=(h/1e6).toFixed(2);let c=g?`Finishing: ${a} MB / ${b} MB`:`Scanning: ${a} MB / ${b} MB`;return logProgress(c)},k=async()=>{for(const a=new Map;;){const b=f.shift();if(!b){if(g)break;await new Promise(a=>setTimeout(a,50));continue}const c=b.fileOverride;let d=0;await writeStreamToOpfs(b.dest,b.entry.name,c,{dirCache:a,onProgress:async a=>{if(i+=a,d+=a,1048576<d){let a=j();a&&(await a),d=0}}});const e=checkYield();e&&(await e)}},l=Array(CONCURRENCY).fill(null).map(k),m=[{source:b,dest:e}];for(;0<m.length;){const{source:a,dest:b}=m.shift();try{for await(const c of a.values()){if("file"===c.kind){const a=await c.getFile();h+=a.size,f.push({dest:b,entry:c,fileOverride:a});let d=j();for(d&&(await d);500<f.length;){await new Promise(a=>setTimeout(a,50));const a=checkYield();a&&(await a)}}else if("directory"===c.kind){const a=await b.getDirectoryHandle(c.name,{create:!0});m.push({source:c,dest:a})}const a=checkYield();a&&(await a)}}catch(a){console.warn("Error reading directory stream:",a)}}g=!0,await Promise.all(l),document.getElementById("folderName").value="",document.getElementById("openFolderName").value=a,await updateRegistryEntry(a,{encryptionType:null}),await logProgress("",!0),await listFolders(),setUiBusy(!1)}async function writeStreamToOpfs(a,b,c,d={}){const{dirCache:e=null,onProgress:f=null}=d,g=b.split("/"),h=g.pop();let i=a;if(0<g.length){let a="";for(const b of g)a+=(a?"/":"")+b,e&&e.has(a)?i=e.get(a):(i=await i.getDirectoryHandle(b,{create:!0}),e&&e.set(a,i))}const j=await i.getFileHandle(h,{create:!0}),k=await j.createWritable();try{if(!f)await k.write(c);else{const a=new TransformStream({async transform(a,b){b.enqueue(a);const c=f(a.byteLength);c&&(await c)}});await c.stream().pipeThrough(a).pipeTo(k,{preventClose:!0})}}finally{try{await k.close()}catch(a){}}}async function listFolders(){if(!isListingFolders){isListingFolders=!0;const a=document.getElementById("folderList");try{const b=await getRegistry();a.textContent="";const c=document.createDocumentFragment(),d=Object.keys(b).sort();d.forEach(a=>{const d=b[a],e=document.createElement("li");e.textContent="password"===d.encryptionType?`[Locked] ${a}`:a,c.appendChild(e)}),a.appendChild(c)}finally{isListingFolders=!1}}}async function deleteFolder(a,b=!1){const c=a||document.getElementById("deleteFolderName").value.trim();if(!c)return alert("Enter a folder name first.");if(b||confirm(`Remove "${c}"?`)){setUiBusy(!0),logProgress("Deleting...",!0);const d=await getOpfsRoot();try{const a=await d.getDirectoryHandle(RFS_PREFIX);await a.removeEntry(c,{recursive:!0})}catch(a){if("NotFoundError"!==a.name)return void alert("RuntimeFS cannot currently remove this folder; try closing other open RuntimeFS tabs.")}await updateRegistryEntry(c,null),a||(document.getElementById("deleteFolderName").value=""),await listFolders(),logProgress("",!0),b||setUiBusy(!1)}}async function openFile(a){const b=(a||document.getElementById("openFolderName").value.trim()).trim(),c=document.getElementById("fileName").value.trim();if(!b)return alert("Provide a folder name.");setUiBusy(!0);const d=await getRegistry(),e=d[b];if(!e)return setUiBusy(!1),alert("Folder not found.");const f=document.getElementById("regex").value.trim(),g=document.getElementById("headers").value.trim();(e.rules!==f||e.headers!==g)&&(await updateRegistryEntry(b,{rules:f,headers:g}));let h=null;if("password"===e.encryptionType){const a=prompt(`Enter password for "${b}":`);if(!a)return setUiBusy(!1);h=await deriveKeyFromPassword(a,base64ToBuffer(e.salt))}const i=await waitForController();await new Promise(a=>{const c=new MessageChannel;c.port1.onmessage=()=>a(),i.postMessage({type:"SET_RULES",rules:f,headers:g,key:h,folderName:b},[c.port2])});const j=c.split("/").map(encodeURIComponent).join("/");window.open(`n/${encodeURIComponent(b)}/${j}`,"_blank"),setUiBusy(!1)}async function exportData(){setUiBusy(!0);try{let a=prompt("Enter a password (or leave blank for no encryption):");if(null===a)return void setUiBusy(!1);a=a||void 0;const b=document.getElementById("c1").checked,c=document.getElementById("c2").checked,d=document.getElementById("c3").checked,e=document.getElementById("c4").checked,f=document.getElementById("c5").checked,g=document.getElementById("c6").checked,h=document.getElementById("c7").checked,i=[];if(e||f){const a=await getRegistry(),b={};for(const[c,d]of Object.entries(a))b[c]={...d};i.push({path:SYSTEM_FILE,data:JSON.stringify(b)})}const j={opfs:[SYSTEM_FILE,".rfs_temp_blobs"]},k={opfs:[]};e&&!f?k.opfs.push(RFS_PREFIX):!e&&f&&j.opfs.push(RFS_PREFIX),await LittleExport.exportData({fileName:"result",password:a,cookies:b,localStorage:c,idb:d,opfs:e||f,cache:g,session:h,customItems:i,include:0<k.opfs.length?k:{},exclude:j,graceful:!0,logger:logProgress,onerror:a=>{console.error("Error while exporting:",a),alert("Error while exporting: "+a)}}),alert("Export complete!")}catch(a){console.error("Export failed:",a),alert("Export failed: "+a.message)}finally{setUiBusy(!1),logProgress("",!0)}}async function importData(){const a=document.createElement("input");a.type="file",a.onchange=a=>{a.target.files[0]&&startImport(a.target.files[0])},a.click()}async function startImport(a){setUiBusy(!0);_registryCache=null;try{const b=await navigator.storage.getDirectory();await Promise.allSettled([b.removeEntry(RFS_PREFIX,{recursive:!0}),b.removeEntry(SYSTEM_FILE),b.removeEntry(".rfs_temp_blobs",{recursive:!0})]);let c=!0,d=!0;logProgress("Starting...",!0);const e={graceful:!0,logger:logProgress,onerror:a=>{"A password is required to decrypt this data."===a.message?c=!1:console.error(a),d=!1,alert(a.message)},onCustomItem:async(a,b)=>{if(a===SYSTEM_FILE){const a=JSON.parse(new TextDecoder().decode(b));await saveRegistry(a)}}};if(a.stream||a instanceof Blob)e.source=a;else throw new Error("Invalid import source.");await LittleExport.importData(e);let f=!1;try{await b.getFileHandle(SYSTEM_FILE),f=!0}catch(a){}if(!f){logProgress("Reconstructing registry...",!0);const a={};try{const c=await b.getDirectoryHandle(RFS_PREFIX);for await(const b of c.keys())a[b]={created:Date.now(),headers:"",rules:""};await saveRegistry(a)}catch(a){}}if(c){await listFolders(),alert(d?"Import finished! Reload to fix any issues.":"Import finished; the import might have been incomplete or stopped. Reload to fix any issues.");const a=document.getElementById("regex"),b=document.getElementById("headers");a.value=localStorage.getItem("fsRegex")||"",b.value=localStorage.getItem("fsHeaders")||""}}catch(a){console.error("Import failed:",a),alert("Import failed: "+a.message)}finally{setUiBusy(!1),logProgress("",!0),navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"INVALIDATE_CACHE"})}}function base64ToBuffer(a){const b=atob(a),c=b.length,d=new Uint8Array(c);for(let e=0;e<c;e++)d[e]=b.charCodeAt(e);return d.buffer}function bufferToBase64(a){let b="";const c=new Uint8Array(a),d=c.byteLength;for(let e=0;e<d;e++)b+=String.fromCharCode(c[e]);return btoa(b)}async function deriveKeyFromPassword(a,b){const c=new TextEncoder,d=await crypto.subtle.importKey("raw",c.encode(a),{name:"PBKDF2"},!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:b,iterations:6e5,hash:"SHA-256"},d,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}let syncTimeout=-1;async function syncFiles(){return folderName&&dirHandle?void(setUiBusy(!0),0<changes.length?(await performSyncToOpfs(),document.getElementById("syncInfo").textContent="Sync complete."):document.getElementById("syncInfo").textContent="No changes to sync.",clearTimeout(syncTimeout),syncTimeout=setTimeout(()=>document.getElementById("syncInfo").textContent="",1e3),setUiBusy(!1)):alert("It seems that syncing isn't supported for your browser.")}async function syncAndOpenFile(){return folderName&&dirHandle?void(setUiBusy(!0),clearTimeout(syncTimeout),0<changes.length?(await performSyncToOpfs(),document.getElementById("syncInfo").textContent="Sync complete."):document.getElementById("syncInfo").textContent="No changes to sync.",syncTimeout=setTimeout(()=>document.getElementById("syncInfo").textContent="",1e3),openFile(folderName)):alert("It seems that syncing isn't supported for your browser.")}async function performSyncToOpfs(){console.log(`Syncing ${changes.length} changes...`),await navigator.locks.request(`lock_rfs_${folderName}`,async()=>{const a=await getOpfsRoot(),b=await a.getDirectoryHandle(RFS_PREFIX),c=await b.getDirectoryHandle(folderName),d=changes.slice(0);changes.length=0;for(const a of d){const b=a.relativePathComponents;if(!b)continue;const d=b.join("/");try{if("deleted"===a.type){let a=c;const d=b.slice(0,-1),e=b[b.length-1];for(const b of d)a=await a.getDirectoryHandle(b);await a.removeEntry(e,{recursive:!0})}else{let a=dirHandle;for(let c=0;c<b.length-1;c++)a=await a.getDirectoryHandle(b[c]);const e=await a.getFileHandle(b[b.length-1]),g=await e.getFile();await writeStreamToOpfs(c,d,g,{totalSize:g.size})}}catch(a){console.warn(`Sync failed for ${d}:`,a)}}})}async function uploadAndEncryptWithPassword(){const a=document.getElementById("encryptFolderName").value.trim(),b=prompt("Password:");if(!a||!b)return;setUiBusy(!0);let c;try{c=await window.showDirectoryPicker({mode:"read"})}catch(a){if("AbortError"!==a.name)throw a}finally{setUiBusy(!1)}const d=await getOpfsRoot(),e=await d.getDirectoryHandle(RFS_PREFIX,{create:!0});try{await e.removeEntry(a,{recursive:!0})}catch(a){if("NotFoundError"!==a.name)return void alert("RuntimeFS cannot currently remove this folder; try closing other open RuntimeFS tabs.")}const f=await e.getDirectoryHandle(a,{create:!0}),g=await f.getDirectoryHandle("content",{create:!0}),h=crypto.getRandomValues(new Uint8Array(16)),i=await deriveKeyFromPassword(b,h),j={},k=[],l=[{dir:c,path:""}];let m=!0,n=0;const o=async()=>{for(;;){if(0===k.length){if(!m)break;const a=checkYield();a&&(await a);continue}const a=k.shift(),{entry:b,entryPath:c,fileId:d}=a,e=checkYield();if(e){const b=(n/1e6).toFixed(2);await logProgress(`Encrypting: ${b} MB (${a.entryPath})`),await e}const f=await b.getFile();n+=f.size,j[c]={id:d,size:f.size,type:f.type};const h=await g.getFileHandle(d,{create:!0}),l=await h.createWritable();if(0<f.size){const a=f.stream().getReader();let b=[],c=0;try{for(;;){const{done:d,value:e}=await a.read();if(e&&(b.push(e),c+=e.byteLength),(d||c>=CHUNK_SIZE)&&0<c){const a=new Uint8Array(c);let e=0;for(const d of b)a.set(d,e),e+=d.byteLength;let f=0;for(;f<c;){const e=c-f;if(!d&&e<CHUNK_SIZE){const d=a.slice(f);b=[d],c=d.byteLength;break}const g=checkYield();g&&(await g);const h=Math.min(CHUNK_SIZE,e),j=a.subarray(f,f+h),k=crypto.getRandomValues(new Uint8Array(12)),m=await crypto.subtle.encrypt({name:"AES-GCM",iv:k},i,j);f+=h,await l.write(k),await l.write(new Uint8Array(m))}f>=c&&(b=[],c=0)}if(d)break}}finally{a.releaseLock();try{await l.close()}catch(a){}}}else await l.close()}},p=(async()=>{for(;0<l.length;){const{dir:a,path:b}=l.shift();for await(const c of a.values()){const a=b?`${b}/${c.name}`:c.name;if("file"===c.kind){const b=crypto.randomUUID();for(k.push({entry:c,entryPath:a,fileId:b});500<k.length;)await new Promise(a=>setTimeout(a,20))}else l.push({dir:c,path:a})}}m=!1})(),q=Array(CONCURRENCY).fill(null).map(o);await p,await Promise.all(q),await logProgress("Saving manifest...",!0);const r=JSON.stringify(j),s=new TextEncoder().encode(r),t=crypto.getRandomValues(new Uint8Array(12)),u=await crypto.subtle.encrypt({name:"AES-GCM",iv:t},i,s),v=await f.getFileHandle("manifest.enc",{create:!0}),w=await v.createWritable();await w.write(h),await w.write(t),await w.write(new Uint8Array(u)),await w.close(),await updateRegistryEntry(a,{encryptionType:"password",salt:bufferToBase64(h)}),document.getElementById("encryptFolderName").value="",await listFolders(),setUiBusy(!1),await logProgress("",!0)}document.addEventListener("DOMContentLoaded",()=>{if("file:"===window.location.protocol)return void alert("RuntimeFS cannot run from a local file:// context; use an online version or localhost instead.");if(!window.isSecureContext)return void alert("RuntimeFS cannot run in a non-secure context.");if(!("serviceWorker"in navigator))return void alert("RuntimeFS cannot run without ServiceWorkers enabled.");document.getElementById("folderName").addEventListener("keydown",a=>{"Enter"!==a.key||currentlyBusy||uploadFolder()}),document.getElementById("openFolderName").addEventListener("keydown",a=>{"Enter"!==a.key||currentlyBusy||(a.shiftKey?openFileInPlace():a.ctrlKey||a.metaKey?syncAndOpenFile():openFile())}),document.getElementById("fileName").addEventListener("keydown",a=>{"Enter"!==a.key||currentlyBusy||(a.shiftKey?openFileInPlace():a.ctrlKey||a.metaKey?syncAndOpenFile():openFile())}),document.getElementById("deleteFolderName").addEventListener("keydown",a=>{"Enter"!==a.key||currentlyBusy||deleteFolder()}),document.getElementById("folderUploadFallbackInput").addEventListener("change",uploadFolderFallback),window.showSaveFilePicker&&(document.getElementById("encryptionSection").style.display="revert");const a=document.body;a.addEventListener("dragover",b=>{b.preventDefault(),a.style.backgroundColor="#385b7e"}),a.addEventListener("dragleave",()=>{a.style.backgroundColor=""}),a.addEventListener("drop",async b=>{if(b.preventDefault(),a.style.backgroundColor="",!currentlyBusy){const a=Array.from(b.dataTransfer.items);if(a.length){if("file"===a[0].kind&&window.FileSystemDirectoryHandle)try{const b=await a[0].getAsFileSystemHandle();if(b&&"directory"===b.kind)return void(await analyzeAndImportFolder(b))}catch(a){}const b=a[0].webkitGetAsEntry?a[0].webkitGetAsEntry():null;if(b&&b.isDirectory){const a=prompt("Please choose a folder name:",b.name);if(a){setUiBusy(!0);const c=[],d=[{entry:b,path:""}];let e=0,g=!1,h=!1;for(;0<d.length;){const{entry:a,path:b}=d.shift();if(a.isFile){const d=await new Promise((b,c)=>a.file(b,c));Object.defineProperty(d,"webkitRelativePath",{value:b+d.name}),c.push(d);const f=d.webkitRelativePath;(f.endsWith(`data/custom/${SYSTEM_FILE}`)||f.endsWith(`custom/${SYSTEM_FILE}`))&&(g=!0),f.endsWith("manifest.enc")&&(h=!0),e++}else if(a.isDirectory){const c=a.createReader();let e;do{e=await new Promise((a,b)=>c.readEntries(a,b));for(const c of e)d.push({entry:c,path:b+a.name+"/"})}while(0<e.length)}let f=logProgress(`Scanned ${e} files...`);f&&(await f)}if(h)return alert("Encrypted folder import via drag-and-drop legacy mode is not supported in your browser."),void setUiBusy(!1);if(g){if(confirm("Found system configuration folder. Import? (This may modify multiple folders or already existing data.)")){const a=LittleExport.folderToTarStream(c,checkYield);return await startImport({stream:()=>a}),void setUiBusy(!1)}setUiBusy(!1)}await logProgress(`Processed ${c.length} files...`,!0),await processFilesAndStore(a,c),setUiBusy(!1)}return}const c=a[0].getAsFile();1===a.length&&c&&confirm(`Import "${c.name}"?`)&&startImport(c)}}}),navigator.serviceWorker.register(SW_URL).then(a=>{a.addEventListener("updatefound",()=>{const b=a.installing;b.addEventListener("statechange",()=>{"installed"===b.state&&navigator.serviceWorker.controller&&location.reload()})})}).catch(console.error),navigator.serviceWorker.addEventListener("message",async a=>{a.data&&"SW_READY"===a.data.type&&(await listFolders()),a.data&&"INVALIDATE_CACHE"===a.data.type&&(await listFolders())}),listFolders();const b=document.getElementById("regex"),c=document.getElementById("headers");b.value=localStorage.getItem("fsRegex")||"",c.value=localStorage.getItem("fsHeaders")||"",b.addEventListener("input",()=>localStorage.setItem("fsRegex",b.value)),c.addEventListener("input",()=>localStorage.setItem("fsHeaders",c.value))});async function openFileInPlace(){if(!navigator.serviceWorker.controller)return void alert("Service Worker is not controlling the page. Please reload and try again.");const a=document.getElementById("openFolderName").value.trim(),b=document.getElementById("fileName").value.trim();if(!a)return alert("Provide a folder name.");setUiBusy(!0);const c=await getRegistry(),d=c[a];if(!d)return setUiBusy(!1),alert("Folder not found.");const e=document.getElementById("regex").value.trim(),f=document.getElementById("headers").value.trim();(d.rules!==e||d.headers!==f)&&(await updateRegistryEntry(a,{rules:e,headers:f}));let g=null;if("password"===d.encryptionType){const b=prompt(`Enter password for "${a}":`);if(!b)return setUiBusy(!1);g=await deriveKeyFromPassword(b,base64ToBuffer(d.salt))}const h=await waitForController();await Promise.race([new Promise(b=>{const c=new MessageChannel;c.port1.onmessage=()=>b(),h.postMessage({type:"SET_RULES",rules:e,headers:f,key:g,folderName:a},[c.port2])}),new Promise((a,b)=>setTimeout(()=>b(new Error("Service Worker response timed out.")),4e3))]);const i=b?b.split("/").map(encodeURIComponent).join("/"):"index.html",j=`n/${encodeURIComponent(a)}/${i}`,k=await fetch(j,{headers:{Accept:"text/html"}});if(!k.ok){if(403===k.status)return setUiBusy(!1),alert("Session authentication failed.");throw new Error(`Failed to load HTML: ${k.status} ${k.statusText}`)}let l=await k.text();const m=j.substring(0,j.lastIndexOf("/")+1),n=`<base href="${m}">`;let o="";k.headers.forEach((a,b)=>{o+=`<meta http-equiv="${b.replace(/"/g,"&quot;")}" content="${a.replace(/"/g,"&quot;")}">\n`}),l=/<head\b[^>]*>/i.test(l)?l.replace(/(<head\b[^>]*>)/i,`$1${n}${o}`):/<html\b[^>]*>/i.test(l)?l.replace(/(<html\b[^>]*>)/i,`$1<head>${n}${o}</head>`):`<head>${n}${o}</head>${l}`,document.open(),document.write(l),document.close(),setUiBusy(!1)}