const APP_SHELL_FILES=["./","./index.html","./main.min.js","sw.min.js"];let pendingNavData=null;const clientSessionStore=new Map,handleCache=new Map,manifestCache=new Map,ruleCache=new Map,RFS_PREFIX="rfs",SYSTEM_FILE="rfs_system.json",CACHE_NAME="fc",NETWORK_ALLOWLIST_PREFIXES=[],FULL_APP_SHELL_URLS=APP_SHELL_FILES.map(a=>new URL(a,self.location.href).href),STORE_ENTRY_TTL=6e5,basePath=new URL("./",self.location).pathname,virtualPathPrefix=basePath+"n/";let registryCache=null,_opfsRoot=null;async function getOpfsRoot(){return _opfsRoot||(_opfsRoot=await navigator.storage.getDirectory()),_opfsRoot}function cleanupExpiredStores(){const a=Date.now();for(const[b,c]of clientSessionStore.entries())a-c.timestamp>STORE_ENTRY_TTL&&clientSessionStore.delete(b)}setInterval(cleanupExpiredStores,6e4);function escapeRegex(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function compileRules(a){if(!a||!a.trim())return[];if(ruleCache.has(a))return ruleCache.get(a);const b=[],c=a.trim().split(/\r?\n/);for(const d of c){const a=d.split("->");if(2>a.length)continue;const c=a[0].trim(),e=a.slice(1).join("->").trim(),f=c.match(/^(.*?)\s+(\$|\$\$|\|\||\|)\s+(.*)$/s);if(!f)continue;const[,g,h,i]=f,j=new RegExp("*"===g.trim()?".*":g.trim());let k;try{"|"===h?k=new RegExp(i,"g"):"$"===h?k=new RegExp(escapeRegex(i),"g"):"||"===h?k=new RegExp(i):"$$"===h?k=new RegExp(escapeRegex(i)):void 0}catch(a){continue}k&&b.push({fileRegex:j,searchRegex:k,replacePart:e})}return 50<ruleCache.size&&ruleCache.clear(),ruleCache.set(a,b),b}function applyRegexRules(a,b,c,d){if(!/^(text\/|application\/(javascript|json|xml|x-javascript|typescript))/.test(c))return b;if(10485760<b.byteLength)return b;try{let c=new TextDecoder().decode(b),e=!1;for(const b of d)b.fileRegex.test(a)&&b.searchRegex.test(c)&&(c=c.replace(b.searchRegex,b.replacePart),e=!0);return e?new TextEncoder().encode(c).buffer:b}catch(c){return console.error(`Error applying regex rules to ${a}:`,c),b}}async function getRegistry(){if(registryCache)return registryCache;try{const a=await getOpfsRoot(),b=await a.getFileHandle(SYSTEM_FILE),c=await b.getFile();registryCache=JSON.parse(await c.text())}catch(a){registryCache={}}return registryCache}async function getCachedFileHandle(a,b,c,d){const e=`${b}/${c}/${d}`;if(handleCache.has(e))return handleCache.get(e);try{const f=await a.getDirectoryHandle(RFS_PREFIX),g=await f.getDirectoryHandle(b),h=await g.getDirectoryHandle(c),i=await h.getFileHandle(d);return handleCache.set(e,i),i}catch(a){return null}}self.addEventListener("install",async function(){const a=await caches.open(CACHE_NAME);await Promise.all(APP_SHELL_FILES.map(async b=>{try{const c=await fetch(b,{cache:"reload"});c.ok&&(await a.put(b,c))}catch(a){console.warn("Failed to cache app shell file:",b)}})),await self.skipWaiting()}),self.addEventListener("activate",a=>{a.waitUntil(async function(){await self.clients.claim(),registryCache=null;try{await getOpfsRoot()}catch(a){}const a=await self.clients.matchAll({includeUncontrolled:!0});for(const b of a)b.postMessage({type:"SW_READY"})}())}),self.addEventListener("message",a=>{if(!a.data)return;const b=a.source?a.source.id:null;switch(a.data.type){case"SET_RULES":const{rules:c,headers:d,key:e}=a.data,f=compileRules(c);if(pendingNavData={rules:c,compiledRules:f,headers:d,key:e},b){const a=clientSessionStore.get(b)||{};a.rules=c,a.compiledRules=f,a.headers=d,e&&(a.key=e),clientSessionStore.set(b,a)}a.ports&&a.ports[0]&&a.ports[0].postMessage("OK"),setTimeout(()=>{pendingNavData&&pendingNavData.key===e&&(pendingNavData=null)},5e3);break;case"INVALIDATE_CACHE":registryCache=null,handleCache.clear(),manifestCache.clear(),a.waitUntil(async function(){const c=await self.clients.matchAll({includeUncontrolled:!0});for(const d of c)d.id!==b&&d.postMessage({type:"INVALIDATE_CACHE",folderName:a.data.folderName})}());break;case"PREPARE_FOR_IMPORT":registryCache=null,a.source&&a.source.postMessage({type:"IMPORT_READY"});}});function parseCustomHeaders(a){if(!a||!a.trim())return[];const b=[];return a.trim().split("\n").forEach(a=>{if(a=a.trim(),a.startsWith("#")||""===a)return;const c=a.split("->");if(2>c.length)return;const[d,...e]=c,f=d.trim(),g=e.join("->").trim(),h=g.indexOf(":");if(-1===h)return;const i=g.substring(0,h).trim(),j=g.substring(h+1).trim();try{const a=new RegExp("^"+f.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/\?/g,".")+"$");b.push({regex:a,header:i,value:j})}catch(a){}}),b}function applyCustomHeaders(a,b,c){if(!c)return a;const d=parseCustomHeaders(c);for(const e of d)e.regex.test(b)&&(a[e.header]=e.value);return a}function getMimeType(a){const b=a.split(".").pop().toLowerCase();return{html:"text/html",htm:"text/html",css:"text/css",js:"text/javascript",mjs:"text/javascript",cjs:"text/javascript",jsx:"text/javascript",ts:"text/javascript",tsx:"text/javascript",json:"application/json",jsonld:"application/ld+json",xml:"application/xml",svg:"image/svg+xml",txt:"text/plain",md:"text/markdown",csv:"text/csv",webmanifest:"application/manifest+json",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",ico:"image/x-icon",avif:"image/avif",bmp:"image/bmp",woff:"font/woff",woff2:"font/woff2",ttf:"font/ttf",otf:"font/otf",eot:"application/vnd.ms-fontobject",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",m4a:"audio/mp4",mp4:"video/mp4",webm:"video/webm",ogv:"video/ogg",vtt:"text/vtt",wasm:"application/wasm",pdf:"application/pdf",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",tar:"application/x-tar",gz:"application/gzip",bin:"application/octet-stream",dat:"application/octet-stream"}[b]||"application/octet-stream"}self.addEventListener("fetch",a=>{const{request:b,clientId:c}=a,d=new URL(b.url);if(NETWORK_ALLOWLIST_PREFIXES.some(a=>d.pathname.startsWith(a)))return;const e=d.origin+d.pathname;let f=null;if(b.referrer&&d.origin===self.location.origin)try{const a=new URL(b.referrer);if(a.pathname.startsWith(virtualPathPrefix)){const b=a.pathname.substring(virtualPathPrefix.length).split("/");0<b.length&&b[0]&&(f=b[0])}}catch(a){}if(f&&!d.pathname.startsWith(virtualPathPrefix)){const g=`${self.location.origin}${virtualPathPrefix}${f}${d.pathname}`;return void a.respondWith((async()=>{const a=new Request(g,b),d=await generateResponseForVirtualFile(a,c);if(404!==d.status)return d;if(FULL_APP_SHELL_URLS.includes(e)){const a=await caches.match(b);return a||fetch(b)}return d})())}return FULL_APP_SHELL_URLS.includes(e)?void a.respondWith((async()=>{const a=await caches.match(b);return a||fetch(b)})()):d.pathname.startsWith(virtualPathPrefix)?void a.respondWith(generateResponseForVirtualFile(b,c)):void a.respondWith(fetch(b))});async function handleEncryptedRequest(a,b,c,d,e){try{const f=4194304,g=28;let h;if(manifestCache.has(b))h=manifestCache.get(b);else{const c=await a.getDirectoryHandle(RFS_PREFIX),e=await c.getDirectoryHandle(b),f=await e.getFileHandle("manifest.enc"),g=await(await f.getFile()).arrayBuffer(),i=g.slice(16,28),j=g.slice(28);try{const a=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},d,j);h=JSON.parse(new TextDecoder().decode(a)),manifestCache.set(b,h)}catch(a){return new Response("Password Incorrect",{status:403})}}const i=h[c]||h[c+"/index.html"];if(!i)return new Response("File not found",{status:404});const j=i.size;if(0===j)return new Response(new Uint8Array(0),{status:200,headers:{"Content-Type":i.type||"application/octet-stream","Content-Length":"0"}});const k=await getCachedFileHandle(a,b,"content",i.id),l=await k.getFile(),m=e.headers.get("Range");let n=0,o=j-1;if(m){const a=m.replace(/bytes=/,"").split("-");n=parseInt(a[0],10),a[1]&&(o=parseInt(a[1],10))}if(n>=j)return new Response(null,{status:416,headers:{"Content-Range":`bytes */${j}`}});const p=Math.floor(n/4194304),q=Math.floor(o/4194304),r=new ReadableStream({async start(a){try{for(let b=p;b<=q;b++){const c=b*f+f>=j,e=c?j%f||f:f,h=b*(f+g),i=l.slice(h,h+(e+g)),k=await i.arrayBuffer();if(0===k.byteLength)break;const m=k.slice(0,12),p=k.slice(12),q=await crypto.subtle.decrypt({name:"AES-GCM",iv:m},d,p),r=new Uint8Array(q),s=b*f,t=Math.max(n,s),u=Math.min(o+1,s+r.length);t<u&&a.enqueue(r.slice(t-s,u-s))}a.close()}catch(b){a.error(b)}}}),s={"Content-Type":i.type||"application/octet-stream","Content-Length":o-n+1,"Content-Range":`bytes ${n}-${o}/${j}`,"Accept-Ranges":"bytes","Cache-Control":"no-store"};return new Response(r,{status:206,headers:s})}catch(a){return new Response("Internal Encryption Error",{status:500})}}async function generateResponseForVirtualFile(a,b){try{async function c(a,b,c){try{const d=c.split("/").map(a=>{try{return decodeURIComponent(a)}catch(b){return a}}).filter(a=>a&&""!==a.trim()),e=[RFS_PREFIX,b,...d];let f=a;for(let a=0;a<e.length-1;a++)f=await f.getDirectoryHandle(e[a]);return await f.getFileHandle(e[e.length-1])}catch(a){return null}}const d=new URL(a.url),{mode:e}=a,f="undefined"!=typeof InternalError;if(f&&"navigate"===e&&!d.searchParams.has("boot"))return d.searchParams.set("boot","1"),new Response(`<!DOCTYPE html><script>location.replace("${d.href}");</script>`,{headers:{"Content-Type":"text/html"}});let g=clientSessionStore.get(b);!g&&pendingNavData&&(g=pendingNavData),g&&(g.timestamp=Date.now(),clientSessionStore.set(b,g)),g=g||{};const h=d.pathname.substring(virtualPathPrefix.length),i=h.split("/").map(a=>decodeURIComponent(a)),j=i[0];let k=i.slice(1).join("/");(!k||k.endsWith("/"))&&(k+="index.html");let l,m;try{l=await getOpfsRoot(),m=await getRegistry()}catch(a){return new Response("System error: OPFS inaccessible",{status:500})}const n=m[j]||{};let o=await c(l,j,k);const p="navigate"===e||(a.headers.get("Accept")||"").includes("text/html");if(!o&&p){const a=await c(l,j,"index.html");a&&(o=a,k="index.html")}if(!o)return new Response("File not found",{status:404});const q=await o.getFile();let r=q.size,s=q.type;s&&"application/octet-stream"!==s||(s=getMimeType(k)||"application/octet-stream");let t=g.compiledRules;!t&&n.rules&&(t=compileRules(n.rules));const u="password"===n.encryptionType,v=t&&0<t.length,w={"Content-Type":s,"Cache-Control":"no-store","Accept-Ranges":"bytes"},x=applyCustomHeaders(w,k,g.headers||n.headers);if(!(u||v)){const b=a.headers.get("Range");if(b){const a=b.replace(/bytes=/,"").split("-"),c=parseInt(a[0],10),d=a[1]?parseInt(a[1],10):r-1;if(c>=r||d>=r)return new Response(null,{status:416,headers:{"Content-Range":`bytes */${r}`}});const e=q.slice(c,d+1);return x["Content-Range"]=`bytes ${c}-${d}/${r}`,x["Content-Length"]=d-c+1,new Response(e,{status:206,headers:x})}return x["Content-Length"]=r,new Response(q,{headers:x})}let y=await q.arrayBuffer();if("password"===n.encryptionType)return g.key?await handleEncryptedRequest(l,j,k,g.key,a):new Response("Session locked. Reload from Main.",{status:403});v&&(y=applyRegexRules(k,y,s,t));const z=s.includes("html");if(z){const a=new TextDecoder;let b=a.decode(y);b.includes("</head>")&&(b=b.replace("</head>","<script>navigator.serviceWorker.controller||navigator.serviceWorker.addEventListener(\"controllerchange\",()=>{window.location.reload()});</script></head>")),y=new TextEncoder().encode(b).buffer}const A=y.byteLength,B=a.headers.get("Range");if(B){const a=B.replace(/bytes=/,"").split("-");let b=parseInt(a[0],10),c=a[1]?parseInt(a[1],10):A-1;if(isNaN(b)&&(b=0),isNaN(c)&&(c=A-1),c>=A&&(c=A-1),b>=A)return new Response(null,{status:416,headers:{"Content-Range":`bytes */${A}`}});const d=c-b+1,e=y.slice(b,c+1);return x["Content-Range"]=`bytes ${b}-${c}/${A}`,x["Content-Length"]=d,new Response(e,{status:206,headers:x})}return x["Content-Length"]=A,new Response(y,{headers:x})}catch(a){return console.error("SW error:",a),new Response("Internal error",{status:500})}}