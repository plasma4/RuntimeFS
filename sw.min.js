const APP_SHELL_FILES=["./","./index.html","./main.min.js","sw.min.js"],NETWORK_ALLOWLIST_PREFIXES=[];let pendingNavData=null;const clientSessionStore=new Map,handleCache=new Map,manifestCache=new Map,ruleCache=new Map,RFS_PREFIX="rfs",SYSTEM_FILE="rfs_system.json",CACHE_NAME="fc",FULL_APP_SHELL_URLS=APP_SHELL_FILES.map(a=>new URL(a,self.location.href).href),STORE_ENTRY_TTL=6e5,basePath=new URL("./",self.location).pathname,virtualPathPrefix=basePath+"n/";function getMimeType(a){const b=a.split(".").pop().toLowerCase();return{html:"text/html",htm:"text/html",css:"text/css",js:"text/javascript",mjs:"text/javascript",cjs:"text/javascript",jsx:"text/javascript",ts:"text/javascript",tsx:"text/javascript",json:"application/json",jsonld:"application/ld+json",xml:"application/xml",svg:"image/svg+xml",txt:"text/plain",md:"text/markdown",csv:"text/csv",webmanifest:"application/manifest+json",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",ico:"image/x-icon",avif:"image/avif",bmp:"image/bmp",woff:"font/woff",woff2:"font/woff2",ttf:"font/ttf",otf:"font/otf",eot:"application/vnd.ms-fontobject",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",m4a:"audio/mp4",mp4:"video/mp4",webm:"video/webm",ogv:"video/ogg",vtt:"text/vtt",wasm:"application/wasm",pdf:"application/pdf",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",tar:"application/x-tar",gz:"application/gzip",bin:"application/octet-stream",dat:"application/octet-stream"}[b]||"text/plain"}let registryCache=null,_opfsRoot=null;async function getOpfsRoot(){return _opfsRoot||(_opfsRoot=await navigator.storage.getDirectory()),_opfsRoot}function cleanupExpiredStores(){const a=Date.now();for(const[b,c]of clientSessionStore.entries())a-c.timestamp>STORE_ENTRY_TTL&&clientSessionStore.delete(b)}setInterval(cleanupExpiredStores,6e4);function escapeRegex(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function compileRules(a){if(!a||!a.trim())return[];if(ruleCache.has(a))return ruleCache.get(a);const b=[],c=a.trim().split(/\r?\n/);for(const d of c){const a=d.split("->");if(2>a.length)continue;const c=a[0].trim();let e=a.slice(1).join("->").trim();const f=c.match(/^(.*?)\s+(\$|\$\$|\|\||\|)\s+(.*)$/s);if(!f)continue;const[,g,h,i]=f;try{const a=new RegExp("*"===g.trim()?".*":g.trim());let c;"{{SCRIPT}}"===i?(c=/(?:<!DOCTYPE\\b[^>]*>)|(?:<head\\b[^>]*>)|(?:<body\\b[^>]*>)|(?:<html\\b[^>]*>)|(?:^)/i,e=`$&<script>${e}</script>`):"|"===h?c=new RegExp(i,"g"):"$"===h?c=new RegExp(escapeRegex(i),"g"):"||"===h?c=new RegExp(i):"$$"===h?c=new RegExp(escapeRegex(i)):void 0,c&&a&&b.push({fileRegex:a,searchRegex:c,replacePart:e})}catch(a){console.warn("Rule compilation failed for line "+d+":",a);continue}}return 50<ruleCache.size&&ruleCache.clear(),ruleCache.set(a,b),b}function applyRegexRules(a,b,c,d){if(!/^(text\/|application\/(javascript|json|xml|x-javascript|typescript))/.test(c))return b;if(10485760<b.byteLength)return b;try{let c=new TextDecoder().decode(b),e=!1;for(const b of d)b.fileRegex.test(a)&&b.searchRegex.test(c)&&(c=c.replace(b.searchRegex,b.replacePart),e=!0);return e?new TextEncoder().encode(c).buffer:b}catch(c){return console.error(`Error applying regex rules to ${a}:`,c),b}}async function getRegistry(){if(registryCache)return registryCache;try{const a=await getOpfsRoot(),b=await a.getFileHandle(SYSTEM_FILE),c=await b.getFile();registryCache=JSON.parse(await c.text())}catch(a){registryCache={}}return registryCache}async function getCachedFileHandle(a,b,c,d){const e=`${b}/${c}/${d}`;if(handleCache.has(e))return handleCache.get(e);try{const f=await a.getDirectoryHandle(RFS_PREFIX),g=await f.getDirectoryHandle(b),h=await g.getDirectoryHandle(c),i=await h.getFileHandle(d);return handleCache.set(e,i),i}catch(a){return null}}self.addEventListener("install",async function(){const a=await caches.open(CACHE_NAME);await Promise.all(APP_SHELL_FILES.map(async b=>{try{const c=await fetch(b,{cache:"reload"});c.ok&&(await a.put(b,c))}catch(a){console.warn("Failed to cache app shell file:",b)}})),await self.skipWaiting()}),self.addEventListener("activate",a=>{a.waitUntil(async function(){await self.clients.claim(),registryCache=null;try{await getOpfsRoot()}catch(a){}const a=await self.clients.matchAll({includeUncontrolled:!0});for(const b of a)b.postMessage({type:"SW_READY"})}())}),self.addEventListener("message",a=>{if(!a.data)return;const b=a.source?a.source.id:null;switch(a.data.type){case"SET_RULES":const{rules:c,headers:d,key:e,folderName:f}=a.data,g=compileRules(c),h=parseCustomHeaders(d);if(pendingNavData||(pendingNavData={}),pendingNavData[f]={rules:c,compiledRules:g,headers:d,compiledHeaders:h,key:e,timestamp:Date.now()},b){const a=clientSessionStore.get(b)||{};a.rules=c,a.compiledRules=g,a.headers=d,a.compiledHeaders=h,e&&(a.key=e),clientSessionStore.set(b,a)}a.ports&&a.ports[0]&&a.ports[0].postMessage("OK"),setTimeout(()=>{pendingNavData&&pendingNavData[f]&&5e3<Date.now()-pendingNavData[f].timestamp&&delete pendingNavData[f]},6e3);break;case"INVALIDATE_CACHE":registryCache=null,handleCache.clear(),manifestCache.clear(),a.waitUntil(async function(){const c=await self.clients.matchAll({includeUncontrolled:!0});for(const d of c)d.id!==b&&d.postMessage({type:"INVALIDATE_CACHE",folderName:a.data.folderName})}());break;case"PREPARE_FOR_IMPORT":registryCache=null,a.source&&a.source.postMessage({type:"IMPORT_READY"});}});function parseCustomHeaders(a){if(!a||!a.trim())return[];const b=[];return a.trim().split("\n").forEach(a=>{if(a=a.trim(),a.startsWith("#")||""===a)return;const c=a.split("->");if(2>c.length)return;const[d,...e]=c,f=d.trim(),g=e.join("->").trim(),h=g.indexOf(":");if(-1===h)return;const i=g.substring(0,h).trim(),j=g.substring(h+1).trim().replace(/^['"]|['"]$/g,"");try{const a=new RegExp("^"+f.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/\?/g,".")+"$");b.push({regex:a,header:i,value:j})}catch(a){}}),b}function applyCustomHeaders(a,b,c){if(!c||!Array.isArray(c))return a;for(const d of c)d.regex.test(b)&&(a[d.header]=d.value);return a}self.addEventListener("fetch",a=>{const{request:b,clientId:c}=a,d=new URL(b.url);if(NETWORK_ALLOWLIST_PREFIXES.some(a=>d.pathname.startsWith(a)))return;if(d.pathname.startsWith(virtualPathPrefix)){const b=d.pathname.substring(virtualPathPrefix.length);if(!b.includes("/"))return void a.respondWith(Response.redirect(d.href+"/",301))}const e=d.origin+d.pathname;let f=null;if(b.referrer&&d.origin===self.location.origin)try{const a=new URL(b.referrer);if(a.pathname.startsWith(virtualPathPrefix)){const b=a.pathname.substring(virtualPathPrefix.length).split("/");0<b.length&&b[0]&&(f=b[0])}}catch(a){}if(f&&!d.pathname.startsWith(virtualPathPrefix)){const g=`${self.location.origin}${virtualPathPrefix}${f}${d.pathname}`;return void a.respondWith((async()=>{const a=new Request(g,b),d=await generateResponseForVirtualFile(a,c);if(404!==d.status)return d;if(FULL_APP_SHELL_URLS.includes(e)){const a=await caches.match(b);return a||fetch(b)}return d})())}return FULL_APP_SHELL_URLS.includes(e)?void a.respondWith((async()=>{const a=await caches.match(b);return a||fetch(b)})()):d.pathname.startsWith(virtualPathPrefix)?void a.respondWith(generateResponseForVirtualFile(b,c)):void a.respondWith(fetch(b))});async function handleEncryptedRequest(a,b,c,d,e,f){try{const g=4194304,h=28;let i;if(manifestCache.has(b))i=manifestCache.get(b);else{const c=await a.getDirectoryHandle(RFS_PREFIX),e=await c.getDirectoryHandle(b),f=await e.getFileHandle("manifest.enc"),g=await(await f.getFile()).arrayBuffer(),h=g.slice(16,28),j=g.slice(28);try{const a=await crypto.subtle.decrypt({name:"AES-GCM",iv:h},d,j);if(i=JSON.parse(new TextDecoder().decode(a)),5<manifestCache.size){const a=manifestCache.keys().next().value;manifestCache.delete(a)}manifestCache.set(b,i)}catch(a){return new Response("Password Incorrect",{status:403})}}const j=i[c]||i[c+"/index.html"];if(!j)return new Response("File not found",{status:404});const k=j.size;if(0===k)return new Response(new Uint8Array(0),{status:200,headers:{"Content-Type":j.type||"application/octet-stream","Content-Length":"0"}});const l=await getCachedFileHandle(a,b,"content",j.id),m=await l.getFile(),n=e.headers.get("Range");let o=0,p=k-1;if(n){const a=n.replace(/bytes=/,"").split("-");o=parseInt(a[0],10),a[1]&&(p=parseInt(a[1],10)),isNaN(o)&&(o=0),isNaN(p)&&(p=k-1),p>=k&&(p=k-1)}if(o>=k)return new Response(null,{status:416,headers:{"Content-Range":`bytes */${k}`}});const q=Math.floor(o/4194304),r=Math.floor(p/4194304),s=new ReadableStream({async start(a){try{for(let b=q;b<=r;b++){const c=b*g+g>=k,e=c?k%g||g:g,f=b*(g+h),i=m.slice(f,f+(e+h)),j=await i.arrayBuffer();if(0===j.byteLength)break;const l=j.slice(0,12),n=j.slice(12),q=await crypto.subtle.decrypt({name:"AES-GCM",iv:l},d,n),r=new Uint8Array(q),s=b*g,t=Math.max(o,s),u=Math.min(p+1,s+r.length);t<u&&a.enqueue(r.slice(t-s,u-s))}a.close()}catch(b){a.error(b)}}}),t={...f,"Content-Type":j.type||"application/octet-stream","Content-Length":p-o+1,"Content-Range":`bytes ${o}-${p}/${k}`,"Accept-Ranges":"bytes","Cache-Control":"no-store"};return new Response(s,{status:206,headers:t})}catch(a){return new Response("Internal Encryption Error",{status:500})}}async function generateResponseForVirtualFile(a,b){try{async function c(a,b,c){try{const d=[RFS_PREFIX,b,...c.split("/").map(a=>{try{return decodeURIComponent(a)}catch(b){return a}}).filter(a=>a&&""!==a.trim())];let e=a;for(let a=0;a<d.length-1;a++)e=await e.getDirectoryHandle(d[a]);return await e.getFileHandle(d[d.length-1])}catch(a){return null}}const d=new URL(a.url),{mode:e}=a,f=d.pathname.substring(virtualPathPrefix.length),g=f.split("/").map(a=>{try{return decodeURIComponent(a)}catch(b){return a}}),h=g[0];let i,j;try{if(i=await getOpfsRoot(),"navigate"===e||!registryCache){const a=await i.getFileHandle(SYSTEM_FILE),b=await a.getFile();registryCache=JSON.parse(await b.text())}j=registryCache}catch(a){j=registryCache||{}}const k=j[h]||{},l="password"===k.encryptionType,m="undefined"!=typeof InternalError,n=k.rules&&0<k.rules.trim().length||k.headers&&0<k.headers.trim().length;if(m&&"navigate"===e&&n&&!d.searchParams.has("boot"))return d.searchParams.set("boot","1"),new Response(`<!DOCTYPE html><script>location.replace("${d.href}");</script>`,{headers:{"Content-Type":"text/html"}});let o=clientSessionStore.get(b);!o&&pendingNavData&&pendingNavData[h]&&(o=pendingNavData[h]),o&&(o.timestamp=Date.now(),clientSessionStore.set(b,o)),o=o||{};let p=g.slice(1).join("/");(!p||p.endsWith("/"))&&(p+="index.html");let q,r=null,s=null,t=0;if(l)q=getMimeType(p);else{r=await c(i,h,p);const b="navigate"===e||(a.headers.get("Accept")||"").includes("text/html");if(!r&&b){const a=await c(i,h,"index.html");a&&(r=a,p="index.html")}if(!r)return new Response("File not found",{status:404});s=await r.getFile(),t=s.size,q=s.type||getMimeType(p)||"application/octet-stream"}let u=o.compiledHeaders;!u&&k.headers&&(u=parseCustomHeaders(k.headers));const v={"Content-Type":q,"Cache-Control":"no-store","Accept-Ranges":"bytes"},w=applyCustomHeaders(v,p,u);if(l)return o.key?await handleEncryptedRequest(i,h,p,o.key,a,w):new Response("Session locked. Reload from the main RuntimeFS interface.",{status:403});if(0===t)return new Response(new Uint8Array(0),{headers:w});let x=o.compiledRules;!x&&k.rules&&(x=compileRules(k.rules));const y=q.startsWith("text/")||q.includes("javascript")||q.includes("json")||q.includes("xml"),z=10485760>t,A=x&&0<x.length,B=A&&y&&z;if(!B){const b=a.headers.get("Range");if(b){const a=b.replace(/bytes=/,"").split("-"),c=parseInt(a[0],10),d=a[1]?parseInt(a[1],10):t-1;return c>=t||d>=t?new Response(null,{status:416,headers:{"Content-Range":`bytes */${t}`}}):(w["Content-Range"]=`bytes ${c}-${d}/${t}`,w["Content-Length"]=d-c+1,new Response(s.slice(c,d+1),{status:206,headers:w}))}return w["Content-Length"]||(w["Content-Length"]=t),new Response(s,{headers:w})}let C=await s.arrayBuffer();B&&(C=applyRegexRules(p,C,q,x));const D=C.byteLength,E=a.headers.get("Range");if(E){const a=E.replace(/bytes=/,"").split("-");let b=parseInt(a[0],10),c=a[1]?parseInt(a[1],10):D-1;return(isNaN(b)&&(b=0),isNaN(c)&&(c=D-1),b>=D)?new Response(null,{status:416,headers:{"Content-Range":`bytes */${D}`}}):(w["Content-Range"]=`bytes ${b}-${c}/${D}`,w["Content-Length"]=c-b+1,new Response(C.slice(b,c+1),{status:206,headers:w}))}return w["Content-Length"]||(w["Content-Length"]=D),new Response(C,{headers:w})}catch(a){return console.error("SW error:",a),new Response("Internal error",{status:500})}}